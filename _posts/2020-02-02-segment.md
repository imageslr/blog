---
layout: post
title: ğŸ“”ã€æ•°æ®ç»“æ„ã€‘çº¿æ®µæ ‘åŸç†åŠå…¶å®ç°
date: 2020/2/2 19:00
permalink: 2020/02/02/segment
---

## é—®é¢˜å¼•å…¥
ç»™å®šä¸€ä¸ªé•¿åº¦ä¸º $n$ çš„åºåˆ—ï¼Œéœ€è¦é¢‘ç¹åœ°æ±‚å…¶ä¸­æŸä¸ªåŒºé—´çš„æœ€å€¼ï¼Œä»¥åŠæ›´æ–°æŸä¸ªåŒºé—´çš„æ‰€æœ‰å€¼ã€‚

æœ€æœ´ç´ çš„ç®—æ³•æ˜¯éå†åœ°æŸ¥è¯¢ä¸æ’å…¥ï¼Œåˆ™æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ $O(qÃ—n)$ï¼Œ$q$ ä¸ºæŸ¥è¯¢çš„ä¸ªæ•°ã€‚åœ¨æ•°æ®é‡å¤§ã€æŸ¥è¯¢æ¬¡æ•°å¤šçš„æ—¶å€™ï¼Œæ•ˆç‡æ˜¯å¾ˆä½çš„ã€‚

å¦ä¸€ç§æ€è·¯æ˜¯ä½¿ç”¨ä¸€ä¸ª $O(n^2)$ çš„æ•°ç»„ï¼Œ`a[i][j]` è¡¨ç¤ºåŒºé—´ `[i,j]` çš„æœ€å°å€¼ã€‚è¿™æ ·æŸ¥è¯¢æ“ä½œçš„å¤æ‚åº¦ä¸º O(1)ï¼Œç›¸å½“äºç”¨ç©ºé—´æ¢æ—¶é—´ã€‚ä½†æ˜¯ä¿®æ”¹æŸä¸ªåŒºé—´çš„å€¼è¾ƒéº»çƒ¦ï¼Œç©ºé—´å¤æ‚åº¦è¾ƒå¤§ã€‚

çº¿æ®µæ ‘å¯ä»¥è§£å†³è¿™ç±»éœ€è¦ç»´æŠ¤**åŒºé—´ä¿¡æ¯**çš„é—®é¢˜ã€‚çº¿æ®µæ ‘å¯ä»¥åœ¨ $O(logn)$ çš„æ—¶é—´å¤æ‚åº¦å†…å®ç°å•ç‚¹ä¿®æ”¹ã€åŒºé—´ä¿®æ”¹ã€åŒºé—´æŸ¥è¯¢ï¼ˆåŒºé—´æ±‚å’Œï¼Œæ±‚åŒºé—´æœ€å¤§å€¼ï¼Œæ±‚åŒºé—´æœ€å°å€¼ï¼‰ç­‰æ“ä½œã€‚

## çº¿æ®µæ ‘ç®€ä»‹
ä»¥åºåˆ— `{5,9,7,4,6,1}` ä¸ºä¾‹ï¼Œä¸€å…± 6 ä¸ªå…ƒç´ ã€‚æ„æˆçš„çº¿æ®µæ ‘æ˜¯è¿™æ ·çš„ï¼š
![](/media/15806411538165.png)

æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªåŒºé—´ï¼ŒèŠ‚ç‚¹çš„å€¼æ˜¯è¯¥åŒºé—´çš„æœ€å°å€¼ï¼Œæ¯”å¦‚æ ¹èŠ‚ç‚¹è¡¨ç¤ºåŒºé—´ `[0,5]` å†…çš„æœ€å°å€¼æ˜¯ 1ã€‚æ¯ä¸ªèŠ‚ç‚¹çš„å·¦å­©å­æ˜¯è¯¥èŠ‚ç‚¹æ‰€ä»£è¡¨çš„çš„åŒºé—´çš„å·¦åŠéƒ¨åˆ†ï¼Œå³å­©å­æ˜¯å³åŠéƒ¨åˆ†ã€‚

**çº¿æ®µæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥å‚¨å­˜ä¸åŒçš„å€¼ï¼Œä¾‹å¦‚åŒºé—´å†…çš„æœ€å¤§å€¼ã€æœ€å°å€¼ã€åŒºé—´çš„æ±‚å’Œç­‰ç­‰**ã€‚ä¸Šå›¾ç¤ºä¾‹ä¸­ï¼Œçº¿æ®µæ ‘èŠ‚ç‚¹ä¿å­˜çš„æ˜¯æœ€å°å€¼ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œçº¿æ®µæ ‘æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š
* å®ƒæ˜¯ä¸€æ£µè¿‘ä¼¼äºå®Œå…¨äºŒå‰æ ‘çš„å¹³è¡¡äºŒå‰æ ‘
* æ¯ä¸ªéå¶èŠ‚ç‚¹ä¸€å®šæœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹
* æ¯ä¸ªå¶å­èŠ‚ç‚¹å¯¹åº”æ•°ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ 

## æ„å»ºçº¿æ®µæ ‘
æ˜¾ç„¶ï¼Œå¯ä»¥é€šè¿‡é€’å½’æ¥æ„å»ºä¸€æ£µçº¿æ®µæ ‘ã€‚å¦‚æœåŒºé—´å·¦å³ä¸‹æ ‡ç›¸ç­‰ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹å¹¶è¿”å›ã€‚å¦åˆ™ï¼Œå…ˆé€’å½’æ„å»ºå·¦åŠåŒºï¼Œå†æ„å»ºå³åŠåŒºï¼Œç„¶åå°†å½“å‰èŠ‚ç‚¹çš„å€¼è®¾ä¸ºå·¦å³å­æ ‘çš„æœ€å°å€¼ã€‚

æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œéœ€è¦åˆ›å»º n ä¸ªèŠ‚ç‚¹ã€‚
ç©ºé—´å¤æ‚åº¦ï¼šO(n)ï¼ŒåŒä¸Šã€‚

çº¿æ®µæ ‘çš„èŠ‚ç‚¹å®šä¹‰ä¸æ„å»ºçº¿æ®µæ ‘çš„ä»£ç å¦‚ä¸‹ï¼ˆä»¥æœ€å°å€¼ä¸ºä¾‹ï¼‰ï¼š
```go
type SegmentTreeNode struct {
	start int
	end   int
	min   int
	left  *SegmentTreeNode
	right *SegmentTreeNode
}

func BuildSegmentTree(nums []int, left, right int) *SegmentTreeNode {
	if left > right {
		return nil
	}
	root := &SegmentTreeNode{left, right, nums[left], nil, nil} // æ ¹æ®èŠ‚ç‚¹åŒºé—´çš„å·¦è¾¹ç•Œå€¼åˆå§‹åŒ–
	if left == right {
		return root
	}
	mid := (left + right) / 2
	root.left = BuildSegmentTree(nums, left, mid)
	root.right = BuildSegmentTree(nums, mid+1, right)
	root.min = min(root.left.min, root.right.min)
	return root
}
```

## å•ç‚¹æ›´æ–°
æ›´æ–°åºåˆ—ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒåŒæ—¶å°†è¿™ç§å˜åŒ–ä½“ç°åˆ°çº¿æ®µæ ‘ä¸Šã€‚åªéœ€è¦é€’å½’åœ°æ‰¾åˆ°è¿™ä¸ªå¶å­èŠ‚ç‚¹ï¼Œæ›´æ–°å€¼ï¼Œç„¶åä¾æ¬¡å‘ä¸Šè¿”å›ï¼Œæ›´æ–°æ²¿é€”æ¯ä¸ªèŠ‚ç‚¹çš„å€¼å³å¯ã€‚

æ—¶é—´å¤æ‚åº¦ï¼š$O(logn)$

ä»£ç ï¼š
```go
func (root *SegmentTreeNode) Modify(index, value int) {
	if root.start == root.end && root.start == index { // æ‰¾åˆ°è¢«æ”¹åŠ¨çš„å¶å­èŠ‚ç‚¹
		root.min = value
		return
	}
	mid := (root.start + root.end) / 2
	if index <= mid {
		root.left.Modify(index, value)
		root.min = min(root.right.min, root.left.min)
	} else {
		root.right.Modify(index, value)
		root.min = min(root.left.min, root.right.min)
	}
}
```

## åŒºé—´æŸ¥è¯¢
æ„å»ºå¥½çº¿æ®µæ ‘ä»¥åï¼Œå¦‚ä½•æŸ¥æ‰¾æŸä¸ªåŒºé—´çš„æœ€å°å€¼ï¼Ÿæ€æƒ³æ˜¯ä»çº¿æ®µæ ‘ä¸­é€‰å‡ºè‹¥å¹²ä¸ªåŒºé—´ï¼Œä½¿å®ƒä»¬åˆå¹¶åæ°å¥½æ¶µç›–æ•´ä¸ªæŸ¥è¯¢åŒºé—´ï¼›æ•´ä¸ªæŸ¥è¯¢åŒºé—´çš„æœ€å°å€¼ï¼Œå°±æ˜¯è¿™äº›å°åŒºé—´çš„æœ€å°å€¼çš„æœ€å°å€¼ã€‚

ä¸€èˆ¬åœ°ï¼Œå¦‚æœè¦æŸ¥è¯¢çš„åŒºé—´æ˜¯ $[l, r]$ï¼Œåˆ™å¯ä»¥å°†å…¶æ‹†æˆæœ€å¤šä¸º $O(logn)$ ä¸ª**æå¤§**çš„åŒºé—´ï¼Œåˆå¹¶è¿™äº›åŒºé—´å³å¯æ±‚å‡º $[l, r]$ çš„ç­”æ¡ˆã€‚

è®¾æŸ¥è¯¢åŒºé—´ä¸º `[start, end]`ï¼Œçº¿æ®µæ ‘çš„å½“å‰èŠ‚ç‚¹ä¸º `root`ã€‚æŸ¥è¯¢åŒºé—´å’Œå½“å‰èŠ‚ç‚¹ä»£è¡¨çš„åŒºé—´æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š
1. æŸ¥è¯¢åŒºé—´åŒ…å«å½“å‰åŒºé—´ï¼Œå³ `start <= root.start && root.end <= end`ï¼Œåˆ™ç›´æ¥è¿”å›å½“å‰åŒºé—´çš„æœ€å°å€¼
2. æŸ¥è¯¢åŒºé—´ä¸å½“å‰åŒºé—´æ— äº¤é›†ï¼Œå³ `start > root.end || end < root.start`ï¼Œè¿”å›æ— ç©·å¤§
3. æŸ¥è¯¢åŒºé—´ä¸å½“å‰åŒºé—´æœ‰äº¤é›†ï¼Œåˆ™åˆ†åˆ«åœ°æŸ¥è¯¢å½“å‰åŒºé—´çš„å·¦å³å­æ ‘ï¼Œè¿”å›å·¦å³å­æ ‘çš„æœ€å°å€¼

æ—¶é—´å¤æ‚åº¦ï¼š$O(logn)$

ä»£ç ï¼š
```go
func (root *SegmentTreeNode) Query(start, end int) int {
	if start <= root.start && end >= root.end {
		return root.min
	}
	if start > root.end || end < root.start {
		return math.MaxInt64
	}
	return min(root.left.Query(start, end), root.right.Query(start, end))
}
```

## åŒºé—´æ›´æ–°
åŒºé—´æ›´æ–°æ˜¯æŒ‡å¯¹æŸä¸ªé•¿åº¦ä¸º m çš„åŒºé—´å†…çš„å…¨éƒ¨å…ƒç´ æ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚

ç®€å•çš„æ–¹æ³•æ˜¯æ‰§è¡Œ m æ¬¡å•ç‚¹æ›´æ–°ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $O(mlogn)$ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯å…ˆé€’å½’åœ°æ›´æ–°å·¦å­æ ‘å’Œæ›´æ–°å³å­æ ‘ï¼Œç„¶åå†æ›´æ–°å½“å‰èŠ‚ç‚¹ã€‚è¿™ç§æ–¹æ³•éœ€è¦é€’å½’åœ°æ›´æ–° m ä¸ªå¶èŠ‚ç‚¹ï¼Œå› æ­¤å…¶æ—¶é—´å¤æ‚åº¦ç›¸æ¯”äº $O(mlogn)$ å¹¶æ²¡æœ‰å¤ªå¤§çš„ä¼˜åŒ–ã€‚è¿™ä¸¤ç§æ–¹æ³•åœ¨ m å¾ˆå¤§çš„æ—¶å€™è€—æ—¶éƒ½æ— æ³•æ¥å—ã€‚

çº¿æ®µæ ‘å¼•å…¥äº†**å»¶è¿Ÿæ ‡è®°**çš„æ¦‚å¿µï¼Œèƒ½å¤Ÿåœ¨ $O(logn)$ çš„æ—¶é—´å†…å®ŒæˆåŒºé—´çš„æ›´æ–°ã€‚ç®€è€Œè¨€ä¹‹ï¼Œåœ¨æ›´æ–°æŸä¸ªåŒºé—´çš„æ‰€æœ‰å€¼æ—¶ï¼Œå¹¶æ²¡æœ‰ç«‹åˆ»æ›´æ–°æ¯ä¸ªå¶èŠ‚ç‚¹çš„å€¼ï¼Œè€Œæ˜¯**å°†æ›´æ–°æ“ä½œæš‚å­˜åœ¨è¿™ä¸ªåŒºé—´æ‰€å¯¹åº”çš„çˆ¶èŠ‚ç‚¹ä¸Šï¼Œä¹‹åç‰¹å®šçš„æ—¶æœºå†å°†æ“ä½œä¸‹ä¼ ç»™å­èŠ‚ç‚¹**ã€‚

è¿˜æ˜¯ä»¥åºåˆ— `{5,9,7,4,6,1}` ä¸ºä¾‹ï¼Œå‡è®¾æˆ‘ä»¬è¦å°†åŒºé—´ `[0,2]` çš„ 3 ä¸ªå…ƒç´ çš„å€¼éƒ½åŠ  2ï¼Œåˆ™å…¶çº¿æ®µæ ‘çš„å˜åŒ–å¦‚ä¸‹æ‰€ç¤ºï¼š
![](/media/15806411655372.jpg)

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹åŒºé—´ `[0,2]` çš„ä¿®æ”¹å¹¶æ²¡æœ‰ä¸‹ä¼ åˆ°å€¼ä¸º `5`ã€`9`ã€`7` çš„ä¸‰ä¸ªå¶èŠ‚ç‚¹ä¸Šï¼Œè€Œæ˜¯å…ˆæš‚å­˜åœ¨çˆ¶èŠ‚ç‚¹çš„ `mark` å­—æ®µé‡Œï¼Œåªæ›´æ–°çˆ¶èŠ‚ç‚¹çš„å€¼ã€‚è¿™ä¸ª `mark` å­—æ®µï¼Œå°±æ˜¯â€œå»¶è¿Ÿæ ‡è®°â€ã€‚è¿™é‡Œæˆ‘ä»¬å¯¹ `[0,2]` çš„æ¯ä¸ªå…ƒç´ åŠ  2ï¼Œé‚£ä¹ˆçˆ¶èŠ‚ç‚¹ä¿å­˜çš„åŒºé—´æœ€å°å€¼è‡ªç„¶ä¹Ÿè¦åŠ  2ã€‚

æœ‰äº†å»¶è¿Ÿæ ‡è®°ï¼Œå¦ä¸€ä¸ªé—®é¢˜å°±æ˜¯**ä»€ä¹ˆæ—¶å€™ä¸‹ä¼ å»¶è¿Ÿæ ‡è®°**ï¼Ÿç­”æ¡ˆæ˜¯**åœ¨è®¿é—®ä»»ä½•èŠ‚ç‚¹çš„å­èŠ‚ç‚¹çš„æ—¶å€™**ï¼Œâ€œè®¿é—®â€æ—¢åŒ…æ‹¬åŒºé—´æ›´æ–°æ—¶çš„è®¿é—®ï¼Œä¹ŸåŒ…æ‹¬åŒºé—´æŸ¥è¯¢æ—¶çš„è®¿é—®ã€‚

åœ¨è®¿é—®ä»»ä½•èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¹‹å‰ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹æœ‰å»¶è¿Ÿæ ‡è®°ï¼Œé‚£ä¹ˆè¦å…ˆå°†å»¶è¿Ÿæ ‡è®°ä¸‹ä¼ ç»™å·¦å³å­èŠ‚ç‚¹ï¼Œæ¸…é™¤å½“å‰èŠ‚ç‚¹çš„å»¶è¿Ÿæ ‡è®°ï¼Œå†å»è®¿é—®å®ƒçš„å­èŠ‚ç‚¹ã€‚è¿™æ ·èƒ½ä¿è¯æ¯æ¬¡è®¿é—®æŸä¸ªèŠ‚ç‚¹æ—¶ï¼Œè¯¥èŠ‚ç‚¹å·²ç»æŒ‰ç…§ä¹‹å‰çš„æ‰€æœ‰æ›´æ–°æ“ä½œä¿®æ”¹è¿‡äº†ï¼Œè¯¥èŠ‚ç‚¹çš„å€¼æ˜¯æœ€æ–°çš„ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“æˆ‘ä»¬è¯•å›¾è®¿é—®è¡¨ç¤º `[0,1]` åŒºé—´çš„èŠ‚ç‚¹æ—¶ï¼Œä¼šå…ˆå°†å…¶çˆ¶èŠ‚ç‚¹çš„å»¶è¿Ÿæ ‡è®°ä¸‹ä¼ ï¼š
![](/media/15806411742891.jpg)

å¢åŠ å»¶è¿Ÿæ ‡è®°åçš„ä»£ç å¦‚ä¸‹ï¼š
```go
// åŒºé—´æ›´æ–°
func (root *SegmentTreeNode) Update(start, end, delta int) {
	if start <= root.start && end >= root.end {
		root.mark += delta
		root.min += delta
		return
	}
	if start > root.end || end < root.start {
		return
	}
	if root.mark != 0 { // å¦‚æœå½“å‰èŠ‚ç‚¹çš„å»¶è¿Ÿæ ‡è®°ä¸ä¸ºç©ºï¼Œä¸‹å‘åˆ°å·¦å³å­èŠ‚ç‚¹
		root.left.mark += root.mark
		root.left.min += root.mark
		root.right.mark += root.mark
		root.right.min += root.mark
		root.mark = 0 // æ¸…ç©ºå½“å‰èŠ‚ç‚¹çš„å»¶è¿Ÿæ ‡è®°
	}
	root.left.Update(start, end, delta)
	root.right.Update(start, end, delta)
	root.min = min(root.left.min, root.right.min)
}

// åŒºé—´æŸ¥è¯¢
func (root *SegmentTreeNode) Query(start, end int) int {
	if start <= root.start && end >= root.end {
		return root.min
	}
	if start > root.end || end < root.start {
		return math.MaxInt64
	}
	// å¢åŠ äº†å¦‚ä¸‹åˆ¤æ–­
	if root.mark != 0 { // å¦‚æœå½“å‰èŠ‚ç‚¹çš„å»¶è¿Ÿæ ‡è®°ä¸ä¸ºç©ºï¼Œä¸‹å‘åˆ°å·¦å³å­èŠ‚ç‚¹
		root.left.mark += root.mark
		root.left.min += root.mark
		root.right.mark += root.mark
		root.right.min += root.mark
		root.mark = 0 // æ¸…ç©ºå½“å‰èŠ‚ç‚¹çš„å»¶è¿Ÿæ ‡è®°
	}
	return min(root.left.Query(start, end), root.right.Query(start, end))
}
```

æœ‰äº†åŒºé—´æ›´æ–°åï¼Œå°±ä¸å†éœ€è¦å•ç‚¹æ›´æ–°äº†ã€‚å•ç‚¹æ›´æ–°å°±ç›¸å½“äºæ˜¯åŒºé—´æ›´æ–°çš„ç‰¹ä¾‹ã€‚

## ä½¿ç”¨æ•°ç»„å­˜å‚¨çº¿æ®µæ ‘
ç”±ä¸Šé¢çš„ç¤ºæ„å›¾å¯çŸ¥ï¼Œçº¿æ®µæ ‘æ˜¯ä¸€æ£µç±»ä¼¼äºå®Œå…¨äºŒå‰æ ‘çš„å¹³è¡¡äºŒå‰æ ‘ã€‚è¿™ç§æ ‘çš„å­˜å‚¨å¯†åº¦è¾ƒé«˜ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨æ•°ç»„æ¥å­˜å‚¨æ ‘ã€‚

ä½¿ç”¨æ•°ç»„å­˜å‚¨æ ‘æ—¶ï¼Œä¸‹æ ‡ `0` ä½œä¸ºæ ¹èŠ‚ç‚¹ã€‚å¯¹äºä¸‹æ ‡ä¸º `i` çš„èŠ‚ç‚¹ï¼Œå…¶å·¦å³å­©å­çš„ä¸‹æ ‡åˆ†åˆ«ä¸º `2i+1`ã€`2i+2`ã€‚

å¯¹äºé•¿åº¦ä¸º $n$ çš„åºåˆ—ï¼Œå¯ä»¥ç›´æ¥ç”³è¯·ä¸€ä¸ªå¤§å°ä¸º `2n+1` çš„æ•°ç»„ã€‚æ¨å¯¼è¿‡ç¨‹å¦‚ä¸‹ï¼š
* è¯¥çº¿æ®µæ ‘ä¸€å…±æœ‰ $n$ ä¸ªç»“ç‚¹ï¼Œé«˜åº¦ä¸º $h=\lceil logn\rceil$ã€‚é™¤äº†æœ€åä¸€å±‚å¤–ï¼Œçº¿æ®µæ ‘çš„ 1 ~ h-1 å±‚æ„æˆäº†ä¸€æ£µæ»¡äºŒå‰æ ‘ã€‚
* é«˜ä¸º $h$ çš„æ»¡äºŒå‰æ ‘çš„èŠ‚ç‚¹æ€»æ•°ä¸º $2^h-1$ã€‚æ•…çº¿æ®µæ ‘çš„èŠ‚ç‚¹æ•° $n$ ä¸é«˜åº¦ $h$ æœ‰å¦‚ä¸‹å…³ç³»ï¼š$2^{h-1}-1 < n <= 2^h-1$ã€‚ä¸ç­‰å¼å·¦å³åˆ†åˆ«ä¹˜ 2ï¼Œæœ‰ $2^h-2<2n$ï¼Œå³ $2^h-1 < 2n+1$ã€‚
* å› æ­¤ `2n+1` ä¸ªèŠ‚ç‚¹èƒ½å¤Ÿå­˜å‚¨é«˜ä¸º $h$ çš„æ»¡äºŒå‰æ ‘ã€‚

ä¹Ÿå¯ä»¥ç›´æ¥ç”³è¯·ä¸€ä¸ªå¤§å°ä¸º `4n` çš„æ•°ç»„æ¥å­˜å‚¨çº¿æ®µæ ‘ã€‚è¿™æ ·å¯ä»¥ä¿å­˜ç¬¬ $h+1$ å±‚çš„æ‰€æœ‰æ— ç”¨çš„å¶èŠ‚ç‚¹ã€‚æ¨å¯¼è¿‡ç¨‹åŒä¸Šï¼š$2^{h-1}-1 < n => 2^{h+1}-1<4n+3$ã€‚

ä»£ç ç•¥ã€‚

## å®Œæ•´ä»£ç 
```go
type SegmentTreeNode struct {
	start int
	end   int
	min   int
	mark  int // å»¶è¿Ÿæ ‡è®°ï¼Œè¡¨ç¤ºåŒºé—´å†…çš„æ‰€æœ‰å€¼çš„å˜åŒ–é‡
	left  *SegmentTreeNode
	right *SegmentTreeNode
}

func BuildSegmentTree(nums []int, left, right int) *SegmentTreeNode {
	if left > right {
		return nil
	}
	root := &SegmentTreeNode{left, right, nums[left], 0, nil, nil} // æ ¹æ®èŠ‚ç‚¹åŒºé—´çš„å·¦è¾¹ç•Œå€¼åˆå§‹åŒ–
	if left == right {
		return root
	}
	mid := (left + right) / 2
	root.left = BuildSegmentTree(nums, left, mid)
	root.right = BuildSegmentTree(nums, mid+1, right)
	root.min = min(root.left.min, root.right.min)
	return root
}

func (root *SegmentTreeNode) Update(start, end, delta int) {
	if start <= root.start && end >= root.end {
		root.mark += delta
		root.min += delta
		return
	}
	if start > root.end || end < root.start {
		return
	}
	root.PushDown()
	root.left.Update(start, end, delta)
	root.right.Update(start, end, delta)
	root.min = min(root.left.min, root.right.min)
}

func (root *SegmentTreeNode) Query(start, end int) int {
	if start <= root.start && end >= root.end {
		return root.min
	}
	if start > root.end || end < root.start {
		return math.MaxInt64
	}
	root.PushDown()
	return min(root.left.Query(start, end), root.right.Query(start, end))
}

func (root *SegmentTreeNode) PushDown() {
	if root.mark != 0 { // å¦‚æœå½“å‰èŠ‚ç‚¹çš„å»¶è¿Ÿæ ‡è®°ä¸ä¸ºç©ºï¼Œä¸‹å‘åˆ°å·¦å³å­èŠ‚ç‚¹
		root.left.mark += root.mark
		root.left.min += root.mark
		root.right.mark += root.mark
		root.right.min += root.mark
		root.mark = 0 // æ¸…ç©ºå½“å‰èŠ‚ç‚¹çš„å»¶è¿Ÿæ ‡è®°
	}
}
```

æµ‹è¯•ï¼š
```go
func main() {
	list := []int{5, 9, 7, 4, 6, 1}
	root := BuildSegmentTree(list, 0, len(list)-1)
	fmt.Println(root.Query(-1, 2)) // åŒºé—´ [-1,2] çš„æœ€å°å€¼ä¸º 5
	fmt.Println(root.Query(3, 1))  // éæ³•åŒºé—´ï¼Œè¿”å› MaxInt64
	root.Update(0, 0, -5)          // ç›¸å½“äº list[0] -= 5
	fmt.Println(root.Query(0, 1))  // åŒºé—´ [0,1] çš„æœ€å°å€¼ä¸º 0
}
```

## æ€»ç»“
ä»€ä¹ˆæ—¶å€™ç”¨çº¿æ®µæ ‘ï¼šå¦‚æœé—®é¢˜å¯ä»¥è½¬åŒ–ä¸ºä¸€ç³»åˆ—åŒºé—´æ“ä½œã€‚æ¯”å¦‚ï¼š
* æŸ¥æ‰¾åŒºé—´çš„æœ€å¤§å€¼ã€æœ€å°å€¼ã€å’Œ
* å¯¹åŒºé—´çš„ä¸€ä¸ªç‚¹çš„å€¼è¿›è¡Œä¿®æ”¹
* å¯¹åŒºé—´çš„ä¸€æ®µå€¼è¿›è¡Œç»Ÿä¸€çš„ä¿®æ”¹

ä»€ä¹ˆæ—¶å€™ä¸èƒ½ç”¨çº¿æ®µæ ‘ï¼šå¦‚æœéœ€è¦åˆ é™¤æˆ–è€…å¢åŠ åŒºé—´ä¸­çš„å…ƒç´ ï¼ŒåŒºé—´å¤§å°å°†å‘ç”Ÿå˜åŒ–ï¼Œçº¿æ®µæ ‘éœ€è¦é‡æ–°æ„å»ºã€‚æ­¤æ—¶æ— æ³•ä½¿ç”¨çº¿æ®µæ ‘ã€‚

æœ¬æ–‡å‘è¡¨åœ¨æˆ‘çš„åšå®¢ [https://imageslr.github.io/](https://imageslr.github.io/)ã€‚æˆ‘ä¹Ÿä¼šåˆ†äº«æ›´å¤šçš„é¢˜è§£ï¼Œä¸€èµ·äº¤æµï¼Œå…±åŒè¿›æ­¥ï¼

---
å‚è€ƒèµ„æ–™ï¼š
* [çº¿æ®µæ ‘ - OI Wiki](https://oi-wiki.org/ds/seg/)
* [çŸ¥ä¹ - å•æ¸…æµ·çš„æ•™ç¨‹](https://zhuanlan.zhihu.com/p/34150142)