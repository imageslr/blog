---
layout: post
title: ğŸ“ºã€ç›‘æ§ã€‘ç ”å‘åŸºæœ¬åŠŸ - Grafana ä½¿ç”¨æŒ‡å— ğŸ†•
date: 2024/4/5 18:00
typora-root-url: ../
typora-copy-images-to: ../media/grafana
---







## ã€‡ã€å‰è¨€

Grafana æ˜¯ä¸€ä¸ªå¼€æºçš„æ•°æ®å¯è§†åŒ–å’Œç›‘æ§å¹³å°ã€‚å®ƒæä¾›äº†ä¸€ä¸ªçµæ´»ä¸”å¼ºå¤§çš„ç•Œé¢ï¼Œå¯ä»¥è¿æ¥åˆ°å„ç§ä¸åŒç±»å‹çš„æ•°æ®æºï¼Œå°†å…¶ä¸­çš„æ•°æ®ä»¥å›¾è¡¨çš„å½¢å¼è¿›è¡Œå±•ç¤ºå’Œåˆ†æã€‚

Grafana çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ä½¿å…¶æˆä¸ºä¸€ä¸ªå¼ºæœ‰åŠ›çš„**æœåŠ¡è¿ç»´å·¥å…·**å’Œ**ä¿¡æ¯è·å–å·¥å…·**ï¼š
- æœåŠ¡è¿ç»´ï¼šå±•ç¤ºæœåŠ¡çš„å·¥ç¨‹æŒ‡æ ‡ï¼Œå¦‚ CPU åˆ©ç”¨ç‡ã€ååã€é”™è¯¯ç‡ç­‰ã€‚
- ä¿¡æ¯è·å–ï¼šå±•ç¤ºæœåŠ¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¦‚å®æ—¶åœ¨çº¿äººæ•°ã€è®¢å•æ•°ç­‰ã€‚

é…ç½®å¥½ Grafana çœ‹æ¿ï¼Œå¯ä»¥æå‡é—®é¢˜æ’æŸ¥çš„æ•ˆç‡ï¼šç›´æ¥åœ¨ Grafana æŸ¥çœ‹å„ç±»æ•°æ®ï¼Œæ— éœ€è·³è½¬åˆ°æ•°æ®æºï¼›ä¹Ÿå¯ä»¥å‘ç°äº‹ä»¶ä¹‹é—´çš„å…³è”ï¼Œä¾‹å¦‚â€œCPU åˆ©ç”¨ç‡å˜é«˜ï¼Œæ˜¯å› ä¸ºè¯·æ±‚é‡æ¶¨äº†â€ã€‚

æœ¬æ–‡å›´ç»• Grafana åœ¨åç«¯å¼€å‘ä¸­çš„é«˜é¢‘ä½¿ç”¨åœºæ™¯ï¼Œåˆ†äº«äº† Grafana çš„åŸºç¡€æ¦‚å¿µã€å¯è§†åŒ–ã€é«˜çº§åŠŸèƒ½ç­‰ã€‚ç›®æ ‡æ˜¯è®©è¯»è€…çŸ¥é“ Grafana æœ‰ä»€ä¹ˆåŠŸèƒ½ï¼Œå…ˆç•™ä¸‹å°è±¡ï¼Œç„¶ååœ¨éœ€è¦é…ç½®çœ‹æ¿æ—¶éšæ—¶æŸ¥é˜…ã€‚

**å­¦ä¹  Grafana çš„æœ€å¥½æ–¹å¼æ˜¯äº²è‡ªä¸Šæ‰‹æ“ä½œ**ã€‚æœ¬æ–‡ä½¿ç”¨ Grafana å®˜æ–¹ç½‘ç«™æä¾›çš„[æ²™ç›’ç¯å¢ƒ](https://play.grafana.org/d/000000012/)åšæ¼”ç¤ºã€‚Grafana çš„æ²™ç›’ç¯å¢ƒæä¾›äº†ä¸€ä¸ª[æµ‹è¯•æ•°æ®æº](https://grafana.com/docs/grafana/latest/datasources/testdata/)ï¼Œå¯ä»¥å£°æ˜å¼åœ°ç”Ÿæˆéšæœºæ—¶åºæ•°æ®ï¼Œç”¨äºè°ƒè¯•çœ‹æ¿çš„åŠŸèƒ½ã€‚



<div class="ant-alert ant-alert" markdown="1">
ğŸ’¡ æ¼”ç¤ºç‰ˆæœ¬ï¼šGrafana v10.3.0
{: .mb-0}
* Grafana Sandboxï¼š<https://play.grafana.org/d/000000012/>
* Grafana å®˜ç½‘ï¼š<https://grafana.com/grafana/>
* Grafana å®˜æ–¹æä¾›çš„æ‰€æœ‰ç¤ºä¾‹ï¼š<https://play.grafana.org/dashboards>

</div>



**Grafana ç•Œé¢æ€»è§ˆ**ï¼š

![image-20240121161253079](/media/grafana/image-20240121161253079.png)

* â‘ ï¼šDashboard æ“ä½œåŒº (æ·»åŠ è¡Œã€æ·»åŠ  Panelã€è®¾ç½®ã€ä¿å­˜)ã€‚
* â‘¡ï¼šæ—¶é—´èŒƒå›´é€‰æ‹©åŒºã€‚
* â‘¢ï¼šè‡ªåŠ¨åˆ·æ–°å‘¨æœŸã€‚
* â‘£ï¼šå˜é‡é€‰æ‹©åŒºï¼Œè§ä¸‹æ–‡ [Variables](#variables)ã€‚
* â‘¤ï¼šé“¾æ¥åŒºï¼Œè§ä¸‹æ–‡ [Links](#links)ã€‚
* â‘¥ï¼šDashboard å†…å®¹åŒºï¼ŒåŒ…å«å¤šä¸ª Rowsï¼Œæ¯ä¸ª Row ä¸‹é¢æœ‰å¤šä¸ª Panelsã€‚





## ä¸€ã€åŸºç¡€

### 1. URL / é“¾æ¥

ä¸€ä¸ª Grafana çœ‹æ¿çš„é“¾æ¥å¦‚ä¸‹æ‰€ç¤ºï¼š

```plaintext
https://play.grafana.org/d/000000012/grafana-play-home?orgId=1
```

ä»å‰å¾€åä¾æ¬¡ï¼š

* `/d` è¡¨ç¤ºçœ‹æ¿ (Dashboard)ï¼Œç›¸åº”çš„ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ (Folder)ï¼Œé‚£ä¹ˆè¿™é‡Œæ˜¯ `/f`ï¼š

  ```plaintext
  https://play.grafana.org/dashboards/f/QQTPJnF4z/
  ```

* `000000012`æ˜¯è¿™ä¸ªçœ‹æ¿çš„å”¯ä¸€`ID`ï¼Œåœ¨æ•´ä¸ªç³»ç»Ÿä¸­ä¸èƒ½é‡å¤ã€‚

* `grafana-play-home` æ˜¯è¿™ä¸ªçœ‹æ¿çš„åç§°ã€‚å¦‚æœæ˜¯ä¸­æ–‡åç§°ï¼Œä¼šè‡ªåŠ¨è½¬æˆæ‹¼éŸ³ã€‚çœ‹æ¿çš„åç§°å¯ä»¥éšä¾¿æ”¹ï¼Œä¹Ÿå¯ä»¥é‡å¤ã€‚é€šè¿‡ URL çš„ `ID` å°±èƒ½ç¡®å®šå”¯ä¸€çš„ Grafana çœ‹æ¿ï¼Œåç§°åªæ˜¯ç”¨æ¥å±•ç¤ºçš„ã€‚

* `?orgId=1` æ˜¯çœ‹æ¿çš„å‚æ•°éƒ¨åˆ†ã€‚æ‰€æœ‰å˜é‡ / å‚æ•°ä¼šé€šè¿‡ `&` è¿æ¥ã€‚

æ¯æ¬¡ä¿®æ”¹çœ‹æ¿çš„[å˜é‡å€¼](#use-variable)ï¼Œurl é‡Œå°±ä¼šå¢åŠ å½¢å¦‚ `var-foo=xxx&var-bar=xxx` çš„å­—ç¬¦ä¸²ï¼Œè¿™æ˜¯å½“å‰çœ‹æ¿çš„**æ‰€æœ‰å˜é‡**çš„å–å€¼ï¼š

![image-20240121150637119](/media/grafana/image-20240121150637119.png)

æ¯æ¬¡ä¿®æ”¹çœ‹æ¿å³ä¸Šè§’çš„æ—¶é—´èŒƒå›´ï¼Œæˆ–è€…é¼ æ ‡æ‹–åŠ¨æ¡†é€‰ä¸€æ®µæ—¶é—´è½´ï¼Œurl é‡Œå°±ä¼šå¢åŠ å½¢å¦‚ `from=xxx&to=xxx` çš„å­—ç¬¦ä¸²ï¼Œè¿™æ˜¯å½“å‰çœ‹æ¿çš„**æ—¶é—´æˆ³**èŒƒå›´ï¼š

```plaintext
https://play.grafana.org/d/000000012/grafana-play-home?orgId=1&from=1689073420099&to=1689076407767
```



ğŸ’¡ å¦‚æœä½ çš„ç›®çš„æ˜¯å¸Œæœ›å…¶ä»–äººåœ¨æ‰“å¼€é“¾æ¥æ—¶èƒ½å¤Ÿè¿˜åŸç°åœºï¼Œé‚£ä¹ˆéœ€è¦åˆ†äº«å¸¦æœ‰æ—¶é—´èŒƒå›´å’Œå˜é‡å–å€¼çš„å®Œæ•´ URLã€‚å¦åˆ™ï¼Œåªéœ€è¦çœ‹æ¿ ID å³å¯ï¼Œæ¯”å¦‚ <https://play.grafana.org/d/000000012>ã€‚
{: .ant-alert .ant-alert-info}



### 2. JSON Model

Grafana çš„æ•´ä¸ªçœ‹æ¿å†…å®¹ â€”â€” åŒ…æ‹¬æ‰€æœ‰çš„è®¾ç½®é¡¹ â€”â€” éƒ½æ˜¯ç”¨ **JSON** æè¿°çš„ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ç›´æ¥ç¼–è¾‘ JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ¥è¾¾åˆ°ä¿®æ”¹çœ‹æ¿çš„ç›®çš„ã€‚æŸäº›åœºæ™¯ä¸‹ï¼Œè¿™æ¯”æ“ä½œ UI ç•Œé¢æ›´æ–¹ä¾¿ã€‚



å¯ä»¥åœ¨â€œDashboard Settings - JSON Modelâ€æ‰¾åˆ°å½“å‰çœ‹æ¿çš„ JSONï¼š

![image-20240121151125411](/media/grafana/image-20240121151125411.png)



JSON Model ä¸­çš„å­—æ®µè¯´æ˜ï¼š

- `iteration`ï¼šåœ¨ä»€ä¹ˆæ—¶é—´è¢«ä¿®æ”¹ã€‚Grafana é€šè¿‡è¿™ä¸ªå­—æ®µæ¥åˆ¤æ–­æ˜¯å¦å’Œå…¶ä»–äººçš„ä¿®æ”¹å‘ç”Ÿå†²çªã€‚
- `id`ã€`uid`ï¼šçœ‹æ¿çš„å”¯ä¸€æ ‡è¯†ï¼Œå³ URL ä¸­çš„ `ID` éƒ¨åˆ†ã€‚
- `links`ï¼šçœ‹æ¿ä¸Šé¢çš„é“¾æ¥

- `templating`ï¼šçœ‹æ¿çš„å˜é‡ Variables
- `panels`ï¼šç±»å‹æ˜¯æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ è¡¨ç¤ºé¡µé¢ä¸­çš„ä¸€ä¸ªé¢æ¿ (Panelï¼Œ`type=graph`)ï¼Œæˆ–è€…ä¸€è¡Œ (Rowï¼Œ`type=row`)ã€‚

- æ‰€æœ‰å­—æ®µè¯´æ˜ï¼š<https://grafana.com/docs/grafana/latest/dashboards/json-model/>



JSON Model çš„å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š

* å¤åˆ¶æ•´ä¸ª Dashboard
* æ‰¹é‡å¤åˆ¶æˆ–ä¿®æ”¹å¤šä¸ª Panels
* æ‰¹é‡æ›¿æ¢æ‰€æœ‰ Panels çš„ DataSource æˆ– Metrics å‰ç¼€
* æ‰¹é‡ä¸ºæ‰€æœ‰ Panels æ³¨å…¥ Query å¯¹åº”çš„å¤–éƒ¨é“¾æ¥ (éœ€è¦ç¼–å†™ä»£ç è§£æå’Œä¿®æ”¹ JSON Model)



ğŸ’¡ å¯ä»¥ç›´æ¥åœ¨ VS Code ç­‰ç¼–è¾‘å™¨é‡Œä¿®æ”¹ JSON Modelï¼Œä¹Ÿå¯ä»¥ç”¨ JavaScript æˆ– Python ä»£ç ä¿®æ”¹ã€‚ä¿®æ”¹åçš„å†…å®¹ç²˜è´´åˆ°è®¾ç½®é¡µï¼Œä¿å­˜å³å¯ç”Ÿæ•ˆã€‚ä½†è¦æ³¨æ„ï¼Œä»¥ä¸‹å‡ ä¸ªå­—æ®µå¿…é¡»ä½¿ç”¨åŸæ¥çš„å€¼ï¼Œä¸èƒ½éšæ„æ›¿æ¢ï¼š`id`ã€`uid`ã€`iteration`ã€‚å¦åˆ™ä¼šæŠ¥é”™ï¼šâ€œDashboard has been changed by someone elseâ€ã€‚
{: .ant-alert .ant-alert-info}



### 3. ç‰ˆæœ¬æ§åˆ¶

åœ¨â€œDashboard Settings - Versionsâ€å¯ä»¥çœ‹åˆ°æœ€è¿‘çš„æ›´æ”¹å†å²ï¼Œå¯ä»¥å›æ»šã€‚

![image-20240121160708350](/media/grafana/image-20240121160708350.png)



### 4. æ–‡ä»¶å¤¹ / æƒé™æ§åˆ¶

Grafana çš„æƒé™æ§åˆ¶éµå¾ª RBAC ç­–ç•¥ã€‚



Grafana æä¾›ä»¥ä¸‹ä¸‰ç§è§’è‰²ï¼š

* Viewerï¼šå¯ä»¥æŸ¥çœ‹ä»ªè¡¨ç›˜ï¼Œä½†ä¸èƒ½ä¿®æ”¹
* Editorï¼šå¯ä»¥æŸ¥çœ‹å’Œä¿®æ”¹ä»ªè¡¨ç›˜
* Adminï¼šå¯ä»¥ç®¡ç†æ•´ä¸ªä»ªè¡¨ç›˜ã€åˆ†é…æƒé™



Grafana çš„æƒé™å¯ä»¥åœ¨ä»¥ä¸‹ä¸¤ä¸ªå±‚çº§é…ç½®ï¼š

* ä»ªè¡¨ç›˜ï¼šä¸€ä¸ª Dashboard æƒé™ã€‚
* æ–‡ä»¶å¤¹ï¼šä¸€ä¸ªæ–‡ä»¶å¤¹å¯ä»¥åŒ…å«å¤šä¸ª Dashboardã€‚æ‹¥æœ‰è¯¥æ–‡ä»¶å¤¹æƒé™çš„ç”¨æˆ·ï¼Œä¼šè‡ªåŠ¨æ‹¥æœ‰æ–‡ä»¶ä¸‹æ‰€æœ‰ä»ªè¡¨ç›˜çš„æƒé™ã€‚



åœ¨â€œDashboard Settings - Permissionsâ€å¯ä»¥ä¿®æ”¹ä»–äººæƒé™ã€‚æƒé™å¯ä»¥åˆ†é…ç»™ä¸ªäººæˆ–å›¢é˜Ÿã€‚

å¦‚æœæƒ³åˆ›å»ºä¸€ä¸ª"åªè¯»"çš„çœ‹æ¿ï¼Œåªéœ€è¦å°† Editor çš„æƒé™ä»`Edit`æ”¹æˆ`View`ã€‚



### 5. å¤åˆ¶ Dashboard

ğŸ’¡ ä¸ºäº†æ–¹ä¾¿ç»ƒä¹ å’Œä¿å­˜ï¼Œå¯ä»¥å…ˆæŠŠ Grafana å®˜æ–¹æ²™ç›’çœ‹æ¿å¤åˆ¶ä¸€ä»½ã€‚
{: .ant-alert .ant-alert-info}



(1) å¦‚æœæœ‰çœ‹æ¿çš„ç¼–è¾‘æƒé™ï¼Œè¿›å…¥çœ‹æ¿çš„è®¾ç½®é¡µï¼Œç‚¹å‡» `Save As...` å³å¯ï¼š
![image-20240121153633234](/media/grafana/image-20240121153633234.png)

(2) å¦‚æœæ²¡æœ‰ç¼–è¾‘æƒé™ï¼Œå¯ä»¥ç‚¹å‡»ã€ŒShare - Export - View JSONã€ï¼Œå¤åˆ¶ JSON Modelã€‚
![image-20240121153808991](/media/grafana/image-20240121153808991.png)

æ¥ä¸‹æ¥æœ‰ä¸¤ç§å¯¼å…¥æ–¹å¼ï¼š

â‘  æ–¹æ³•ä¸€ï¼š"New Dashboard - Import â†’ Import via dashboard JSON model"ï¼Œç²˜è´´ JSON Model å†…å®¹ï¼ŒLoadã€‚ç„¶åä¿®æ”¹ Name å’Œ UIDï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

<img src="/media/grafana/image-20240121154205507.png" alt="image-20240121154205507" width="500px"/>

<img src="/media/grafana/image-20240121154243996.png" alt="image-20240121154205507" width="500px"/>

â‘¡ æ–¹æ³•äºŒï¼šæ–°å»ºä¸€ä¸ªç©ºç™½çœ‹æ¿ï¼Œè¿›å…¥è¯¥çœ‹æ¿çš„ã€ŒDashboard Settings - JSON Modelã€ï¼Œä½¿ç”¨è¯¥çœ‹æ¿çš„ `id`ã€`uid`ã€`title`ã€`iteration` å­—æ®µçš„å€¼ï¼Œåˆå¹¶åˆ°åˆšæ‰å¤åˆ¶çš„ JSON Model ä¸­ï¼Œæ•´ä½“ç²˜è´´è¦†ç›–ï¼Œä¿å­˜ã€‚



### 6. å¤åˆ¶ Panel

**å¦‚æœæœ‰ç¼–è¾‘æƒé™**ï¼š

1. Panel èœå• â†’ More â†’ Copyï¼š

   ![image-20240121154733223](/media/grafana/image-20240121154733223.png)

2. Add panel â†’ Paste panel

   ![image-20240121155038233](/media/grafana/image-20240121155038233.png)



**å¦‚æœæ²¡æœ‰ç¼–è¾‘æƒé™**ï¼š

1. Panel èœå• â†’ Inspect â†’ Panel JSONï¼š
   ![image-20240121154904497](/media/grafana/image-20240121154904497.png)

2. å°†è¿™ä¸ª Panel JSON å¤åˆ¶åˆ°ç›®æ ‡ Dashboard çš„ JSON Model - Panels ä¸­ã€‚æˆ–è€…å‚è€ƒè¿™ä¸ª Panel JSONï¼Œæ‰‹åŠ¨é…ç½®ä¸€ä¸ªä¸€æ ·çš„ Panelã€‚



### 7. ä¿å­˜çœ‹æ¿é»˜è®¤çŠ¶æ€
{: #default}

çœ‹æ¿çš„æ‰€æœ‰çŠ¶æ€éƒ½å¯ä»¥è¢«ä¿å­˜ã€‚åŒ…æ‹¬ï¼š

- å½“å‰é€‰æ‹©çš„æ—¶é—´èŒƒå›´
- å½“å‰å„ä¸ªå˜é‡çš„å€¼
- å½“å‰æ¯ä¸€è¡Œæ˜¯å±•å¼€è¿˜æ˜¯æŠ˜å çš„
- å³ä¸Šè§’çš„è‡ªåŠ¨åˆ·æ–°å‘¨æœŸ



å»ºè®®ï¼š

1. å»ºè®®è®¾ç½®å¥½çœ‹æ¿çš„é»˜è®¤çŠ¶æ€ï¼Œæ¯”å¦‚ï¼šé€‰æ‹©æœ€è¿‘ 3 å°æ—¶ã€é€‰æ‹©é»˜è®¤æœºæˆ¿ã€å±•å¼€æ ¸å¿ƒæŒ‡æ ‡è¡Œã€å…¶ä»–è¡Œé»˜è®¤æŠ˜å ã€‚
2. ç‚¹å‡» Saveï¼Œå‹¾é€‰ä»¥ä¸‹ä¸¤é¡¹ï¼Œä¿å­˜çœ‹æ¿çš„é»˜è®¤çŠ¶æ€ï¼š

   ![image-20240121160835012](/media/grafana/image-20240121160835012.png)
3. åˆ†äº«ä»…å¸¦æœ‰ `/d/{unique_id}` çš„ç®€å• URLï¼Œæ¯”å¦‚ <https://play.grafana.org/d/000000012>



## äºŒã€å˜é‡ Variables
{: #variables}

å˜é‡ (Variables) æ˜¯ Grafana çš„ä¸€é¡¹å¼ºå¤§åŠŸèƒ½ï¼Œå¯ä»¥ç”¨äºåˆ›å»ºåŠ¨æ€çš„ã€å¯é…ç½®çš„ã€æ¨¡æ¿åŒ–çš„ä»ªè¡¨ç›˜ã€‚æ¯”å¦‚åˆ›å»ºä¸€ä¸ªé€šç”¨å¤§ç›˜ï¼Œç›‘æ§å¤šä¸ªæœåŠ¡ï¼Œè€Œæ— éœ€ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºå•ç‹¬çš„çœ‹æ¿ã€‚

### 1. é…ç½®å˜é‡

#### å˜é‡ç±»å‹

å˜é‡å¯ä»¥åœ¨â€œDashboard Settings - Variablesâ€é…ç½®ã€‚

![image-20240121225242430](/media/grafana/image-20240121225242430.png)



Grafana æä¾›äº†å¤šç§å˜é‡ç±»å‹ï¼š

1. Queryï¼šä½¿ç”¨æ•°æ®æºçš„æŸ¥è¯¢è¯­è¨€ï¼ŒåŠ¨æ€è·å–å¯é€‰é¡¹ã€‚
2. Customï¼šæ‰‹åŠ¨å®šä¹‰ä¸€ç»„å¯é€‰é¡¹ï¼Œæ˜¯ä¸€ç»„ç”¨é€—å·åˆ†éš”çš„å€¼åˆ—è¡¨ï¼Œè¿™äº›å€¼å°†ä½œä¸ºä¸‹æ‹‰èœå•çš„é€‰é¡¹ã€‚
3. Textboxï¼šæ·»åŠ ä¸€ä¸ªæ–‡æœ¬æ¡†ï¼Œç”¨æˆ·å¯ä»¥è¾“å…¥ä»»æ„æ–‡æœ¬ã€‚
4. Constantï¼šå¸¸é‡ï¼Œåœ¨ä»ªè¡¨ç›˜çš„å˜é‡åŒºåŸŸä¸å¯è§ã€‚
5. Intervalï¼šå®šä¹‰ä¸€ç»„æ—¶é—´é—´éš”ï¼Œå¯ä»¥ç”¨äºæ›´æ”¹ä»ªè¡¨æ¿ä¸Šçš„æ—¶é—´èŒƒå›´æˆ–èšåˆçº§åˆ«ã€‚
6. Data sourceï¼šè¿™ç§ç±»å‹çš„å˜é‡åœ¨æœ‰å¤šä¸ªæ•°æ®æºæ—¶ç‰¹åˆ«æœ‰ç”¨ï¼Œå…è®¸ç”¨æˆ·åŠ¨æ€åˆ‡æ¢æ•°æ®æºã€‚
7. Ad-hoc filtersï¼šåŠ¨æ€æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤è¿‡æ»¤æ¡ä»¶ï¼Œä»…æ”¯æŒæŸäº›æ•°æ®æºï¼Œå¦‚ ESã€InfluxDBã€‚



ä¸‹é¢å°†ä¾æ¬¡ä»‹ç»ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„å˜é‡ç±»å‹ï¼š`Custom`ã€`Textbox`ã€`Query`ã€‚



##### Custom

![image-20240121230253110](/media/grafana/image-20240121230253110.png)

* â‘ ï¼šæä¾›å‡ ä¸ªå›ºå®šçš„é€‰é¡¹ï¼Œé€—å·åˆ†éš”ã€‚

* â‘¡ï¼šé»˜è®¤å•é€‰ï¼Œå¯ä»¥æ”¯æŒå¤šé€‰ã€‚

* â‘¢ï¼šå½“å…è®¸å¤šé€‰æ—¶ï¼Œå¯ä»¥æœ‰ä¸€ä¸ªâ€œå…¨é€‰â€çš„é€‰é¡¹ã€‚

* â‘£ï¼šâ€œå…¨é€‰â€çš„é»˜è®¤å€¼æ˜¯æ‰€æœ‰å€¼æ‹¼èµ·æ¥ï¼Œå¦‚`{value1, value2, ...}`ã€‚ å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªå€¼ï¼Œå¦‚`*`ã€‚

* â‘¤ï¼šCustom å˜é‡çš„é€‰æ‹©æ¡†ä¹Ÿæ˜¯è¾“å…¥æ¡†ï¼Œå¯ä»¥ä¸´æ—¶è¾“å…¥ä¸€ä¸ªä¸å­˜åœ¨äºå›ºå®šé€‰é¡¹ä¸­çš„å€¼ï¼Œå¦‚ä¸‹å›¾ã€‚

<img src="/media/grafana/image-20240121230355503.png" alt="image-20240121230355503" style=";" />



##### Textbox

ç®€åŒ–ç‰ˆçš„ Customã€‚å°±æ˜¯ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œå¯ä»¥è¾“å…¥ä»»æ„å€¼ã€‚

![image-20240121230508338](/media/grafana/image-20240121230508338.png)



##### Query

Custom ç±»å‹çš„å˜é‡åªèƒ½æä¾›å›ºå®šçš„å€¼åˆ—è¡¨ï¼Œè€Œ Query ç±»å‹çš„å˜é‡å¯ä»¥**å®æ—¶æŸ¥è¯¢**æŸä¸ª metrics name ä¸‹çš„æŸä¸ª tag çš„å–å€¼ã€‚å…¸å‹çš„åº”ç”¨åœºæ™¯æ˜¯â€œè·å–æœåŠ¡çš„æ‰€æœ‰ä¸Šæ¸¸ / ä¸‹æ¸¸â€ã€‚

ä¸‹é¢ä»¥ OpenTSDB æ•°æ®æºä¸ºä¾‹ï¼Œæ¼”ç¤º Query ç±»å‹å˜é‡çš„ä½¿ç”¨æ–¹å¼ï¼š

![image-20240121230725233](/media/grafana/image-20240121230725233.png)

* â‘ ï¼šè¿™é‡Œæ˜¯ OpenTSDB æä¾›çš„æŸ¥è¯¢è¯­æ³•ï¼Œè¯¦è§[å®˜ç½‘](http://opentsdb.net/docs/build/html/user_guide/query/examples.html)ï¼Œä½œç”¨æ˜¯è·å– Metrics æ‰“ç‚¹ `throughput` ä¸‹çš„ `from` tag çš„æ‰€æœ‰å€¼ã€‚å…¶æ—¶é—´èŒƒå›´é»˜è®¤æ˜¯æœ€è¿‘ä¸€ä¸ªå°æ—¶ã€‚
* â‘¡ï¼šå»ºè®®å°†é€‰é¡¹åˆ—è¡¨è®¾ç½®ä¸º**å­—æ¯é¡ºåºæ’åˆ—**ï¼Œæ–¹ä¾¿æŸ¥æ‰¾å’Œé€‰æ‹©
* â‘¢ï¼šå¦‚æœ Query ä¸­ç”¨åˆ°äº†åˆ«çš„å˜é‡ï¼Œéœ€è¦å°†`Refresh`è®¾ç½®ä¸º`On Dashboard Load`æˆ–è€…`On Time Range Change`ã€‚

Query Options ä¸­çš„â€œ**Regex**â€å¯ä»¥ç”¨æ¥è¿‡æ»¤å­—æ®µã€‚æ¯”å¦‚åªä¿ç•™ `test_` å¼€å¤´çš„å€¼ï¼š

```
/^test_/
```

å¦å¤–ï¼Œç”¨æ­£åˆ™çš„æ•è·ç»„ï¼Œå¯ä»¥æŠŠ `test_` å‰ç¼€å»æ‰ï¼Œåªä¿ç•™åé¢çš„å†…å®¹ã€‚å…¸å‹çš„ä½¿ç”¨åœºæ™¯æ˜¯ï¼šQuery è¿”å›äº† `test_foo`å’Œ`test_bar`ï¼Œä½†éœ€è¦æå–å…¶ä¸­çš„ `foo` å’Œ `bar` ç”¨åœ¨ Panel ä¸­ï¼š

```
/((?<=test_)*)/
```

> <https://grafana.com/docs/grafana/latest/variables/filter-variables-with-regex/>



ğŸ’¡å»ºè®®ï¼š**èƒ½ç”¨ Query å°½é‡ä¸è¦ç”¨ Custom**ï¼Œè¿™æ ·èƒ½ä¿è¯çœ‹æ¿çš„é€šç”¨æ€§ã€‚
{: .ant-alert .ant-alert-info}

ğŸ’¡ åœ¨é…ç½® Panel æ—¶ï¼Œç»å¸¸ä¼šå‡ºç°`foo=*`è¿™æ ·çš„è¯­æ³•ï¼Œç”¨æ¥æšä¸¾`foo`çš„æ‰€æœ‰å¯èƒ½å–å€¼ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå»ºè®®å°†`foo`é…ç½®ä¸ºä¸€ä¸ª Query å˜é‡ï¼Œä½¿ç”¨`foo=${foo}`ã€‚ä¸ä»…é»˜è®¤æ•ˆæœä¸€æ ·ï¼Œå¿…è¦æ—¶è¿˜å¯ä»¥æŒ‰å€¼è¿‡æ»¤ä¸‹é’»ï¼Œé€æ­¥å®šä½é—®é¢˜ã€‚
{: .ant-alert .ant-alert-info}



#### å˜é‡é»˜è®¤å€¼

å¦‚ [1.7-ä¿å­˜çœ‹æ¿é»˜è®¤çŠ¶æ€](#default) æ‰€è¿°ï¼š

- é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“é€‰æ‹©äº†æŸä¸ªå˜é‡åï¼Œå˜é‡çš„å€¼ä¼šé™„åœ¨ URL é‡Œï¼Œä»¥ `var-xxx` å¼€å¤´ï¼š
    ```plaintext
    https://play.grafana.org/d/000000012/grafana-play-home-copy-2?orgId=1&var-query0=123&from=1705823477666&to=1705824050985&var-foo=1233&var-bar=213&var-custom=1&var-custom=2&var-from=222
    ```


- ä¿å­˜çœ‹æ¿æ—¶ï¼Œä¼šæç¤ºæ˜¯å¦è¦ä¿å­˜å½“å‰é€‰æ‹©çš„å˜é‡å€¼ä½œä¸ºé»˜è®¤å€¼ï¼š

  ![image-20240121160835012](/media/grafana/image-20240121160835012.png)

- ä¿å­˜é»˜è®¤å€¼åï¼Œè®¿é—®ä¸æºå¸¦ä»»ä½•å‚æ•°çš„çœ‹æ¿é“¾æ¥ï¼š<https://play.grafana.org/d/000000012>ï¼Œå°±ä¼šè‡ªåŠ¨åŠ è½½å˜é‡çš„é»˜è®¤å€¼ã€‚

å› æ­¤ï¼Œå»ºè®®ä¿å­˜å˜é‡çš„é»˜è®¤å€¼ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œé»˜è®¤å€¼éƒ½æ˜¯ `All`ï¼Œç„¶åè®©ç”¨æˆ·è‡ªå·±è¿‡æ»¤ã€‚æŸäº›å˜é‡å¯ä»¥è®¾ç½®æˆä¸€ä¸ªä¸»è¦çš„å€¼ï¼Œé¿å…é¢æ¿ä¸Šæ›²çº¿å¤ªå¤šï¼Œå¯¹ç”¨æˆ·äº§ç”Ÿå¹²æ‰°ã€‚


### 2. ä½¿ç”¨å˜é‡
{: #use-variable}

#### åŸºæœ¬ä½¿ç”¨

ä½¿ç”¨å˜é‡çš„è¯­æ³•æ˜¯**`$varname`**æˆ–**`${varname}`**ã€‚æ¨èä½¿ç”¨åä¸€ç§ï¼Œå› ä¸ºåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œgrafana æ— æ³•æ­£ç¡®åŒºåˆ†å˜é‡åçš„è¾¹ç•Œï¼Œæ¯”å¦‚æŠŠ`$service.xxx.xxx`è¯†åˆ«æˆä¸€ä¸ªå˜é‡ï¼Œä½†å®é™…ä¸Šåº”è¯¥æ˜¯`$service`ã€‚

åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨å˜é‡ï¼š

- æ ‡é¢˜
- é“¾æ¥
- Query
- Alias
- Tags
- ...

ğŸ’¡ Grafana å®˜æ–¹çš„æ¼”ç¤ºçœ‹æ¿ï¼š[Templated dynamic dashboard](https://play.grafana.org/d/000000056/)ã€‚åŸºäºå˜é‡å®ç°äº†ä¸€ä¸ªåŠ¨æ€çœ‹æ¿ï¼Œå˜é‡çš„å€¼æ¥è‡ª Graphite Queryã€‚
{: .ant-alert .ant-alert-info}

#### å˜é‡ä¿®é¥°ç¬¦

å˜é‡ä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å½“æŸä¸ªå˜é‡å¯ä»¥å¤šé€‰æ—¶ï¼ŒGranafa é»˜è®¤ä¼šç”Ÿæˆ`{foo,bar}`å½¢å¼çš„å­—ç¬¦ä¸²ã€‚å¯ä»¥é€šè¿‡ä¿®é¥°ç¬¦æ§åˆ¶ç”Ÿæˆçš„å­—ç¬¦ä¸²å½¢å¼ã€‚

å¸¸ç”¨çš„ä¿®é¥°ç¬¦ï¼š

- `${var:pipe}`ï¼šç”Ÿæˆ`foo|bar`ã€‚è¿™ä¸ªæ˜¯ OpenTSDB tags èƒ½å¤Ÿè¯†åˆ«çš„è¯­æ³•ï¼Œå› æ­¤å»ºè®® tags ä¸­æ‰€æœ‰å˜é‡å€¼éƒ½å†™æˆ`:pipe`çš„å½¢å¼ã€‚
- `${var:queryparam}`ï¼šç”Ÿæˆ`var=foo&var=bar`ã€‚å¦‚æœå¸Œæœ›é€šè¿‡ URL ä¼ é€’å˜é‡ï¼Œéœ€è¦è¿™æ ·å†™ã€‚
- æ‰€æœ‰ä¿®é¥°ç¬¦è§ [Grafana æ–‡æ¡£](https://grafana.com/docs/grafana/latest/variables/advanced-variable-format-options/)ã€‚

<div class="ant-alert ant-alert-info" markdown=1>
ğŸ’¡ Grafana å®˜æ–¹çš„æ¼”ç¤ºçœ‹æ¿ï¼š[Template VariablesFormatting Options](https://play.grafana.org/d/cJtIfcWiz/template-variable-formatting-options?orgId=1)ã€‚ä¿®æ”¹ servers å˜é‡ï¼ŒæŸ¥çœ‹ä¸åŒä¿®é¥°ç¬¦çš„æ¸²æŸ“ç»“æœã€‚
![image-20230722221428085](/media/grafana/image-20230722221428085.png)
</div>

#### å†…ç½®å˜é‡ / å…¨å±€å˜é‡

Grafana å†…ç½®äº†ä¸€äº›å…¨å±€å˜é‡ï¼Œæ¯”å¦‚æ—¶é—´èŒƒå›´`$__from`ã€`$__to`ï¼Œæˆ–è€…`$__all_variables` (æ‰€æœ‰å˜é‡çš„å½“å‰å–å€¼ï¼Œè¡¨ç¤ºä¸º url query parameters å½¢å¼) ç­‰ã€‚è¯¦è§ [Grafana æ–‡æ¡£](https://grafana.com/docs/grafana/latest/variables/variable-types/global-variables/)ã€‚

å…¨å±€å˜é‡ä¹Ÿæ”¯æŒä¿®é¥°ç¬¦ã€‚`$__from`å’Œ`$__to`è¿˜æ”¯æŒå¦‚ä¸‹çš„æ—¥æœŸæ ¼å¼åŒ–è¯­æ³•ï¼š

![image-20240121232653652](/media/grafana/image-20240121232653652.png)

ğŸ’¡å…¸å‹ä½¿ç”¨åœºæ™¯ï¼šé…ç½®äº†è·³è½¬åˆ°å…¶ä»–çœ‹æ¿çš„é“¾æ¥ï¼Œå¸Œæœ›é™„å¸¦å½“å‰çœ‹æ¿çš„æ‰€æœ‰çŠ¶æ€ (å˜é‡å€¼ã€æ—¶é—´èŒƒå›´ç­‰)ã€‚Grafana å®˜æ–¹ Demoï¼š[å†…ç½®å…¨å±€å˜é‡](https://play.grafana.org/d/HYaGDGIMk/templating-global-variables-and-interpolation?orgId=1)ã€‚
{: .ant-alert .ant-alert-info}

### 3. å˜é‡è”åŠ¨ / é”®å€¼å¯¹æ˜ å°„

å˜é‡è”åŠ¨æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­çš„å¸¸è§éœ€æ±‚ï¼Œä½†å½“å‰ Grafana æ²¡æ³•å¾ˆå¥½æ”¯æŒã€‚ä¸€ä¸ªå…¸å‹çš„åœºæ™¯æ˜¯æ ¹æ®åœ°åŒºé€‰æ‹©ç›¸åº”çš„æœåŠ¡å™¨ï¼š

```Plaintext
   A    |  B 
------- | -------
cn      | shanghai
us      | new_york, silicon
```

è§£å†³æ–¹æ³•æ˜¯ï¼š

* A é…ç½®æˆä¸€ä¸ª Custom å˜é‡ï¼Œå€¼æ˜¯ `cn, us`
* B é…ç½®æˆä¸€ä¸ª Query ç±»å‹çš„å˜é‡ï¼Œå€¼å½¢å¦‚ `Query($A)`

B çš„å…·ä½“è¯­æ³•ä¾èµ–äºé€‰æ‹©çš„æ•°æ®æºã€‚å¯ä»¥æŠŠ A â†’ B çš„æ˜ å°„å­˜åˆ° Prometheus ç­‰æ•°æ®åº“æ¥ç­›é€‰ï¼Œä½†è¿™æ ·æ¯”è¾ƒéº»çƒ¦ã€‚æ›´ç®€å•çš„æ–¹æ³•æ˜¯å®ç°ä¸€ä¸ªç±»ä¼¼ [httpbin.org](httpbin.org) è¿™æ ·çš„ *Echo æœåŠ¡*ï¼Œå¹¶æ³¨å†Œä¸ºä¸€ä¸ªæ•°æ®æºã€‚è¿™ç§ Echo æœåŠ¡ä¼šå°†ä¼ é€’è¿‡æ¥çš„å‚æ•°åŸå°ä¸åŠ¨åœ°è¿”å›ï¼Œæ¯”å¦‚è®¿é—® <a href="https://httpbin.org/get?cn=shanghai&us=new_york&us=silicon">https://httpbin.org/get?cn=shanghai&us=new_york&us=silicon</a> ä¼šå¾—åˆ°ä»¥ä¸‹ç»“æœï¼š

```json
{
  "args": {
    "cn": "shanghai", 
    "us": [
      "new_york", 
      "silicon"
    ]
  }
}
```

ç„¶åä½¿ç”¨ `jsonPath: $.args[$A]` å°±èƒ½è·å–åˆ° A å¯¹åº”çš„ B çš„å€¼äº†ã€‚

> å…·ä½“å®ç°ç•¥ï¼Œæ¬¢è¿è¡¥å……ã€‚å¦‚æœæœ‰éœ€æ±‚ï¼Œè¯·è”ç³»å…¬å¸çš„ Grafana ç®¡ç†å‘˜ã€‚

### 4. å˜é‡å¾ªç¯ / Repeated
{: #variable-repeat}

Grafana æä¾›äº† Repeated rows å’Œ Repeated Panels åŠŸèƒ½ï¼Œå¯ä»¥æ ¹æ®å˜é‡çš„å€¼åŠ¨æ€å¤åˆ¶è¡Œæˆ–é¢æ¿çš„å¸ƒå±€ã€‚

ä»¥è¡Œé‡å¤ä¸ºä¾‹ã€‚åœ¨è¡Œæ ‡é¢˜æ—è¾¹ç‚¹å‡»é½¿è½®å›¾æ ‡ï¼Œæ‰“å¼€â€œRow Optionsâ€ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªåä¸º "Repeat for" çš„é€‰é¡¹ã€‚åœ¨è¿™é‡Œé€‰æ‹©è¦æŒ‰å“ªä¸ªå˜é‡é‡å¤ï¼Œç„¶åä¿å­˜ã€‚

![image-20240121235350674](/media/grafana/image-20240121235350674.png)

ç„¶åè¿™ä¸€è¡Œä¾¿ä¼šæŒ‰ç…§è¯¥å˜é‡çš„å½“å‰å–å€¼é‡å¤å¤šæ¬¡ï¼Œè¡Œå†…çš„æ‰€æœ‰é¢æ¿å‡ä¼šè¢«å¤åˆ¶ã€‚åœ¨é‡å¤è¡Œå†…ï¼Œè®¿é—®é‡å¤å˜é‡å `$custom` å°†ä¼šè·å–åˆ°å•ä¸ªå€¼ï¼Œè€Œä¸æ˜¯æ‰€æœ‰å€¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![image-20240121235543708](/media/grafana/image-20240121235543708.png)

![image-20240121235615376](/media/grafana/image-20240121235615376.png)


<div class="ant-alert ant-alert-info" markdown=1>
ğŸ’¡ Grafana å®˜æ–¹çš„æ¼”ç¤ºçœ‹æ¿ï¼š
{: .pb-0 .mb-0}

* [Repeat Rows](https://play.grafana.org/d/000000153/repeat-rows?orgId=1)ã€[æ°´å¹³é‡å¤](https://play.grafana.org/d/k3PEoCpnk/repeating-a-row-with-a-non-repeating-panel-and-horizontal-repeating-panel?orgId=1)ã€[å‚ç›´é‡å¤](https://play.grafana.org/d/7lS-ojt7z/repeating-a-row-with-a-non-repeating-panel-and-vertical-repeating-panel?orgId=1)
* [Repeat Panels](https://play.grafana.org/d/000000025)ã€[æ°´å¹³é‡å¤](https://play.grafana.org/d/WVpf2jp7z/repeating-a-panel-horizontally?orgId=1)ã€[å‚ç›´é‡å¤](https://play.grafana.org/d/OY8Ghjt7k/repeating-a-panel-vertically?orgId=1)
</div>


## ä¸‰ã€æ•°æ®æº Data Sources

åœ¨é…ç½® Grafana çœ‹æ¿æ—¶ï¼Œéœ€è¦åœ¨â€œQueryâ€åŒºåŸŸé€‰æ‹©ä¸€ä¸ªæ•°æ®æºï¼š

![image-20240405225426753](/media/grafana/image-20240405225426753.png)

Grafana æœ‰ä¸¤ç§å¸¸è§çš„æ•°æ®æºï¼š[OpenTSDB](http://opentsdb.net/) å’Œ [Bosun](https://bosun.org/)ã€‚Grafana çš„æ•°æ®æºéœ€è¦åœ¨ç®¡ç†å‘˜åå°é…ç½®ï¼Œè¿™é‡Œæˆ‘ä»¬å‡è®¾è¯»è€…äº†è§£è¿™ä¸¤ä¸ªæ•°æ®æºã€ä¸”å…¬å¸å·²ç»åœ¨ Grafana ç³»ç»Ÿä¸­é…ç½®å¥½äº†è¿™ä¸¤ä¸ªæ•°æ®æºã€‚æ¥ä¸‹æ¥ä»‹ç»è¿™äº›æ•°æ®æºçš„ä½¿ç”¨æ–¹æ³•ã€‚

Grafana Play Ground è¿˜æä¾›äº†ä¸€ä¸ª[æµ‹è¯•æ•°æ®æº](https://grafana.com/docs/grafana/latest/datasources/testdata/)ï¼Œå¯ä»¥å£°æ˜å¼åœ°ç”Ÿæˆéšæœºæ—¶åºæ•°æ®ã€‚åœ¨åé¢çš„â€œå¯è§†åŒ–â€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨è¿™ä¸ªæµ‹è¯•æ•°æ®æºç”Ÿæˆç¤ºä¾‹æ•°æ®ã€‚

### 1. OpenTSDB

![img](/media/grafana/opentsdb_query_editor.png)

- Aggregator (ç¬¬ä¸€è¡Œ)ï¼šèšåˆæ–¹å¼ï¼Œavg æˆ– sumã€‚
- Aliasï¼šæä¾›ä¸€ä¸ªå¯è¯»çš„åˆ«åã€‚å¸¸è§çš„ä½¿ç”¨æ–¹å¼æ˜¯é…åˆâ€œFilters / Tagsâ€ï¼Œæ¯”å¦‚æœ‰ä¸ª tag key çš„åç§°ä¸º `cluster`ï¼Œalias å°±å¯ä»¥é…ç½®ä¸º `cluster=$tag_cluster`ï¼Œå½“æœ‰  `default`ã€`test` ä¸¤ä¸ª cluster æ—¶ï¼Œä¼šæ˜¾ç¤º `cluster=default`ã€`cluster=test`ã€‚

  ![image-20240405230738145](/media/grafana/image-20240405230738145.png)
- Filters / Tagsï¼šæ ¹æ® tags key=value è¿‡æ»¤ã€‚è¿™ä¸¤ä¸ªæ˜¯äº’æ–¥çš„ï¼Œé…ä¸€ä¸ªå°±å¯ä»¥ã€‚æ¨èç”¨ Filtersã€‚
  - literal_orï¼šåŒ…å«ï¼Œæ”¯æŒ `.`ã€`*` é€šé…ç¬¦
  - not_literal_orï¼šä¸åŒ…å«
  - regexpï¼šPOSIX å…¼å®¹æ ¼å¼çš„æ­£åˆ™è¡¨è¾¾å¼
  - group_by (ä»… Filters æœ‰æ­¤é€‰é¡¹ï¼ŒTags æ€»æ˜¯ true)ï¼šå¦‚æœå‹¾é€‰ä¸Šï¼Œé‚£ä¹ˆåŒåçš„ tag_value ä¼šèšåˆæˆä¸€æ¡æ›²çº¿
- Rateï¼šå¯¹åº” OpenTSDB çš„ rate_counter ç±»å‹çš„æ‰“ç‚¹ã€‚é€‰æ‹©åä¼šå‡ºç°â€œCounterâ€é€‰é¡¹ã€‚
- TopKï¼šä»…ä¿ç•™è‹¥å¹²ä¸ªæœ€é«˜/æœ€ä½å€¼ï¼Œé€‚ç”¨äºæŒ‰ Tag åˆ†ç»„åæ›²çº¿è¿‡å¤šçš„åœºæ™¯ã€‚æ¯”å¦‚å±•ç¤ºæ‰€æœ‰ä¸»æœºçš„ CPU åˆ©ç”¨ç‡æ—¶ï¼Œå¯ä»¥ä»…å±•ç¤º top 10 å’Œ bottom 10ã€‚

ğŸ’¡  å…³äº OpenTSDB æ•°æ®æºçš„æ›´å¤šé…ç½®è¯´æ˜ï¼Œè¯¦è§ [Grafana å®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/grafana/latest/datasources/opentsdb/)ã€‚
{: .ant-alert .ant-alert-info}

### 2. Bosun

æ‰€æœ‰ OpenTSDB ç±»å‹çš„éƒ½å¯ä»¥å†™æˆ bosun çš„å½¢å¼ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªOpenTSDB æŸ¥è¯¢ï¼Œå®ƒä½¿ç”¨ä»¥ä¸‹å‚æ•°ï¼š

* metricï¼šsystem.cpu.usage
* aggregatorï¼šsum
* tagsï¼šhost=*
* downsampleï¼š5m-avg

å°†è¿™ä¸ª OpenTSDB æŸ¥è¯¢è½¬æ¢ä¸º Bosun è¡¨è¾¾å¼åå¦‚ä¸‹æ‰€ç¤ºï¼š

```text
$q("sum:5m-avg:system.cpu.usage{host=*}")
```

ä½†æ˜¯ bosun çš„å¯è¯»æ€§ä¸é«˜ï¼Œé™¤äº†ä»¥ä¸‹åœºæ™¯å¤–ï¼Œ**ä¸å»ºè®®ä½¿ç”¨ Bosunï¼Œå°½é‡ä½¿ç”¨ OpenTSDB**ï¼š

* è®¡ç®—é”™è¯¯ç‡ã€‚ä½¿ç”¨ Bosun å¯ä»¥è¡¨ç¤ºä¸¤ä¸ªæ—¶åºæ‰“ç‚¹çš„é™¤æ³•ï¼š

   ```text
   $succ = q("sum:rate{counter}:success.throughput", "$start", "")
   $error = q("sum:rate{counter}:error.throughput", "$start", "")
   $error / ($succ + $error)
   ```

ğŸ’¡  å…³äº Bosun è¯­æ³•çš„æ›´å¤šè¯´æ˜ï¼Œè¯¦è§ [Bosun å®˜æ–¹æ–‡æ¡£](https://bosun.org/)ã€‚
{: .ant-alert .ant-alert-info}

### 3. Grafana Test Data

[TestData data source](https://grafana.com/docs/grafana/latest/datasources/testdata/) æ˜¯ Grafana å®˜æ–¹æä¾›çš„ä¸€ä¸ªæµ‹è¯•æ•°æ®æºï¼Œç”¨äºç”Ÿæˆæ¨¡æ‹Ÿçš„æ—¶åºæ•°æ®ï¼Œéå¸¸é€‚åˆç”¨æ¥æµ‹è¯•çœ‹æ¿çš„åŠŸèƒ½ã€‚Grafana çš„æ²™ç›’ç¯å¢ƒå†…ç½®äº†è¿™ä¸ªæ•°æ®æºï¼Œæˆ‘ä»¬åœ¨ç¬¬äº”èŠ‚â€œå¯è§†åŒ–â€ç« èŠ‚ä¸­ä¼šä½¿ç”¨åˆ°ã€‚

![img](/media/grafana/screenshot-testdata-add-10.0.png)

* Random Walkï¼šéšæœºæ•°ï¼Œå¯ä»¥æŒ‡å®š Series num

* Slow Queryï¼šæŒ‡å®šè¿”å›æ•°æ®çš„è€—æ—¶

* CSV Contextï¼šè‡ªå·±ç²˜è´´ä¸€ä¸ª CSV æ•°æ®ï¼Œæ¯”å¦‚ï¼š

  ```plaintext
  Name,Value,Unit,Color
  Temperature,10,degree,green
  Pressure,100,bar,blue
  Speed,30,km/h,red
  ```


## å››ã€ç•Œé¢ Rows / Panels

è¿™ä¸€èŠ‚ä»‹ç»äº†â€œè¡Œâ€å’Œâ€œé¢æ¿â€çš„åŸºç¡€æ“ä½œå’Œé…ç½®ã€‚

### 1. è¡Œ Rows

åœ¨ Dashboard çš„å³ä¸Šè§’æ·»åŠ è¡Œï¼š

![image-20240405232212269](/media/grafana/image-20240405232212269.png)

å½“è¡ŒæŠ˜å èµ·æ¥æ—¶ï¼Œæœ€å³è¾¹ä¼šæœ‰ä¸€ä¸ª Handler (ä¸‹å›¾â‘ )ï¼Œç‚¹å‡»æ‹–åŠ¨å¯ä»¥è°ƒæ•´è¯¥è¡Œçš„ä½ç½®ï¼š

![image-20240405232114641](/media/grafana/image-20240405232114641.png)

é¼ æ ‡ç§»åŠ¨åˆ°è¡Œæ ‡é¢˜ä¸Šï¼Œä¼šå‡ºç°ä¸€ä¸ªé½¿è½®å’Œåˆ é™¤æŒ‰é’® (ä¸Šå›¾â‘¡)ã€‚ç‚¹å‡»é½¿è½®ï¼Œå¯ä»¥ä¿®æ”¹è¡Œçš„æ ‡é¢˜ï¼Œæˆ–é…ç½®æŒ‰å˜é‡é‡å¤è¡Œ ([è§ 2.4](#variable-repeat))ã€‚

### 2. é¢æ¿ Panels

é¢æ¿ (Panel) å³ä¸Šè§’çš„èœå•æä¾›äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

![image-20240405232533826](/media/grafana/image-20240405232533826.png)

* Viewï¼šåœ¨æ•´ä¸ªç½‘é¡µçª—å£é‡Œï¼Œæ”¾å¤§æŸ¥çœ‹è¿™ä¸ªé¢æ¿
* Editï¼šç¼–è¾‘é¢æ¿ï¼Œé«˜é¢‘ä½¿ç”¨
* Shareï¼šåˆ†äº«è¯¥é¢æ¿çš„é“¾æ¥
* Explortï¼šåŸºäºè¯¥é¢æ¿é…ç½®çš„ Queryï¼Œè°ƒæ•´æŸ¥è¯¢å‚æ•°ã€æ—¶é—´èŒƒå›´æˆ–å¯è§†åŒ–å½¢å¼
* Inspectï¼šæŸ¥çœ‹è¯¥é¢æ¿çš„ Data å’Œ JSON Model (åœ¨æ²¡æœ‰ç¼–è¾‘æƒé™çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ JSON æŸ¥çœ‹é¢æ¿é…ç½®çš„ Metrics åç§°æ˜¯ä»€ä¹ˆ)

é¼ æ ‡ç§»åŠ¨åˆ°é¢æ¿çš„æ ‡é¢˜åŒºåŸŸï¼Œé¼ æ ‡æŒ‡é’ˆä¼šå˜æˆä¸€ä¸ªåå­—ï¼Œæ‹–åŠ¨å¯ä»¥ç§»åŠ¨é¢æ¿ã€‚

### 3. æå‡é¢æ¿çš„å¯è¯»æ€§
{: #readability}

ç‚¹å‡»â€œEditâ€è¿›å…¥é¢æ¿çš„ç¼–è¾‘é¡µï¼Œå³è¾¹æä¾›äº†ä¸€ç³»åˆ—é…ç½®é¡¹ï¼š

![image-20240405233608653](/media/grafana/image-20240405233608653.png)

å¼ºè°ƒä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼Œæé«˜é¢æ¿çš„å¯è¯»æ€§å’Œä¿¡æ¯é‡ï¼Œä½¿å…¶æ›´æ˜“ç”¨ï¼š

* **æ ‡é¢˜**ï¼šé¢æ¿çš„æ ‡é¢˜éœ€è¦å’Œ metrics å«ä¹‰ä¸€è‡´
  * `cpu.utilization` â†’ `CPU åˆ©ç”¨ç‡`
  * `xxx.calledby.success` â†’ `XXX æ¥å£æˆåŠŸ QPS`
* **æè¿°**ï¼šä¸ºçœ‹æ¿è¡¥å……å¿…è¦çš„ã€æ›´è¯¦ç»†çš„æè¿°ä¿¡æ¯ï¼Œç”¨æˆ·å°†é¼ æ ‡ç§»åŠ¨åˆ°å›¾æ ‡ä¸Šæ—¶ä¼šå±•ç¤º
  ![image-20240405234150418](/media/grafana/image-20240405234150418.png)
  
* **Tooltip é™åºæ’åˆ—**ï¼šå’Œå˜é‡è¦æŒ‰å­—æ¯åºæ’åˆ—ä¸€æ ·ï¼Œé¼ æ ‡æµ®åŠ¨åˆ°é¢æ¿ä¸Šå±•ç¤ºçš„ Tooltip è¦é™åºæ’åˆ—ï¼Œé™åºæ’åˆ—ååˆšå¥½å’Œæ‰€æœ‰æ›²çº¿ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºä¸€è‡´ã€‚Panel Settings - Display - Hover tooltip - Sort Order - **Decreasing** (ä¸åŒç‰ˆæœ¬çš„ Grafanaï¼Œé…ç½®é¡¹çš„è·¯å¾„å¯èƒ½æœ‰åŒºåˆ«)

* **Legend æŒ‰è¡¨æ ¼å±•ç¤º**ï¼Œé€‚ç”¨äºæ›²çº¿åˆ†ç»„è¾ƒå¤šçš„åœºæ™¯ï¼šLegend - å‹¾é€‰â€œShow As Tableâ€ + â€œMax / Avg / Currentâ€ï¼ŒæŒ‰ avg é™åºæ’åˆ— (ä¸åŒç‰ˆæœ¬çš„ Grafanaï¼Œé…ç½®é¡¹çš„è·¯å¾„æˆ–åç§°å¯èƒ½æœ‰åŒºåˆ«ï¼Œæ¯”å¦‚ä¸‹å›¾æœ€æ–°ç‰ˆçš„ Grafana ä¸­ `avg` è¢«æ›¿æ¢æˆäº† `Mean`)

  ![image-20240405235749133](/media/grafana/image-20240405235749133.png)
  * Show As Tableï¼šæŒ‰è¡¨æ ¼å±•ç¤ºï¼Œå¯ä»¥æ–¹ä¾¿åœ°å‡åºæˆ–é™åºæ’åˆ—ã€‚
  * Avg (Mean)ï¼šäº†è§£è¿™æ®µæ—¶é—´èŒƒå›´çš„æ•´ä½“æƒ…å†µï¼Œæ¨èè®¾ç½®ä¸ºé»˜è®¤æ’åºæ–¹å¼ã€‚
  * Maxï¼šæœ‰æ—¶å€™æœ‰ç”¨ï¼Œæ¯”å¦‚æƒ³æŸ¥çœ‹æ™šé«˜å³°çš„ CPU åˆ©ç”¨ç‡å³°å€¼ã€‚
  * Current (Last)ï¼šçœ‹å®æ—¶å˜åŒ–ï¼Œæ¯”å¦‚é”™è¯¯æ•°æœ‰æ²¡æœ‰ä¸‹é™ã€‚

* **è®¾ç½®åˆé€‚çš„å•ä½ï¼š**Panel Settings - Axes - Unitã€‚å¸¸ç”¨çš„åœºæ™¯ï¼š
  * QPSï¼šMisc - short
  * åˆ©ç”¨ç‡ï¼šMisc - Percent (0.0~1.0)
  * å¸¦å®½ï¼šData - bytes
  * å»¶è¿Ÿï¼šTime - microseconds (us)

* **Alias**ï¼šåº”å½“åŒ…å«å°½å¯èƒ½å¤šçš„ä¿¡æ¯é‡ã€‚
  * é»˜è®¤çš„æ›²çº¿åç§°æ˜¯æ ¹æ® Query é…ç½®è‡ªåŠ¨ç”Ÿæˆï¼Œå½¢å¦‚ `metrics_name{key1=value1, key2=value2}`ï¼Œæ¯”å¦‚ X è°ƒç”¨ Y æœåŠ¡çš„ `foo` æ¥å£ï¼Œåç§°é»˜è®¤æ˜¯ `throughput{from=X, to=Y, api=foo}`ï¼Œå¯è¯»æ€§å¾ˆå·®ã€‚
  * å»ºè®®é…ç½®ä¸€ä¸ªæ›´ç›´è§‚çš„ Aliasï¼Œæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œå¯ä»¥æ”¹ä¸º `$tag_from â†’ $tag_to::$tag_api()`ï¼Œå±•ç¤ºå‡ºæ¥å½¢å¦‚ `X â†’ Y::foo()`ï¼Œèƒ½ç›´è§‚çœ‹å‡ºæ‰“ç‚¹çš„å«ä¹‰ã€‚
  
* **é…ç½®å’Œé¢æ¿ Query å«ä¹‰ä¸€è‡´çš„é“¾æ¥**ï¼šç”¨æˆ·å‘ç°æŸä¸ªé¢æ¿çš„æ•°æ®æœ‰å¼‚å¸¸åï¼Œç»å¸¸éœ€è¦åŸºäºè¯¥é¢æ¿çš„ Queryï¼Œåšæ›´è¿›ä¸€æ­¥çš„æŸ¥è¯¢ã€‚è¿™é‡Œå¯ä»¥ç”¨ Grafana é¢æ¿è‡ªå¸¦çš„ Explore åŠŸèƒ½ï¼Œä½†æ›´å¤šæ—¶å€™ç”¨æˆ·ä¼šè·³è½¬åˆ°å¦ä¸€ä¸ªå¹³å°ï¼Œæ¯”å¦‚ OpenTSDB æ•°æ®æºæ€»æ˜¯æœ‰ä¸€ä¸ªé…å¥—çš„ Metrics å¹³å°ã€æ•°æ®åº“æ€»æ˜¯æœ‰ä¸€ä¸ª SQL å¹³å°... å¯ä»¥å°† Query å¯¹åº”çš„å¹³å°é“¾æ¥é™„åœ¨ Panel ä¸Šï¼Œç”¨æˆ·å°±å¯ä»¥åœ¨å·¦ä¸Šè§’â€œæè¿°â€åŒºåŸŸç›´æ¥ç‚¹å‡»é“¾æ¥è·³è½¬ã€‚Panel Settings - Links - Addã€‚

  ![image-20240406000638035](/media/grafana/image-20240406000638035.png)

  * URL é‡Œå¯ä»¥ä½¿ç”¨å˜é‡ã€‚å¸¸è§çš„æ˜¯å°† Query ç”¨åˆ°çš„å˜é‡å’Œ Grafana å½“å‰é€‰æ‹©çš„æ—¶é—´èŒƒå›´é™„åœ¨ URL é‡Œä¼ é€’è¿‡å»ï¼Œè¿™æ ·ç”¨æˆ·ç‚¹å¼€é“¾æ¥åï¼Œçœ‹åˆ°çš„æ˜¯å’Œ Grafana é¢æ¿ä¸€æ¨¡ä¸€æ ·çš„æ•°æ®ï¼Œèƒ½ç›´æ¥é…ç½®å…¶ä»–ç­›é€‰æ¡ä»¶ã€‚
  * å‹¾é€‰â€œOpen in new tabâ€


<div class="ant-alert ant-alert-info" markdown="1">

ğŸ’¡ é¢æ¿çš„å¯è¯»æ€§è¶Šé«˜ï¼Œæ’æŸ¥é—®é¢˜çš„æ•ˆç‡è¶Šé«˜ï¼š
{: .pb-0 .mb-0}

- å¯è¯»æ€§ä½çš„è¡¨ç°ï¼šæ€»æ˜¯éœ€è¦ç¼–è¾‘é¢æ¿ï¼ŒæŸ¥çœ‹ metrics åç§°å’Œ tags æ˜¯ä»€ä¹ˆã€‚
- å¯è¯»æ€§é«˜çš„è¡¨ç°ï¼šé€šè¿‡é¢æ¿æ ‡é¢˜å’Œæ›²çº¿åç§°ï¼Œå°±å¯ä»¥ç›´è§‚åœ°è·å–è¿™äº›ä¿¡æ¯ã€‚

</div>



## äº”ã€å¯è§†åŒ– Visualizations

è¿™ä¸€å°èŠ‚ä¼šä»‹ç» Grafana çš„å‡ ç§å¯è§†åŒ–å½¢å¼åŠå…¶é…ç½®é¡¹ã€‚å»ºè®®åœ¨ Grafana æ²™ç›’é‡Œç¼–è¾‘æµ‹è¯•ï¼Œä¼šæ›´ç›´è§‚ã€‚å¦‚æœè¦è·å–çœ‹æ¿è®¾è®¡çš„çµæ„Ÿï¼Œå¯ä»¥å‚è€ƒé™„å½•ä¸­çš„ Grafana Demoã€‚

### Graph æŠ˜çº¿å›¾

90% ä»¥ä¸Šçš„åœºæ™¯ï¼Œç”¨æŠ˜çº¿å›¾å°±å¤Ÿäº†ï¼š

![image-20240406001337537](/media/grafana/image-20240406001337537.png)

ğŸ’¡ Grafana å®˜æ–¹çš„æ¼”ç¤ºçœ‹æ¿ï¼š[â‘  Time Series æ—¶åºå›¾ï¼ˆæŠ˜çº¿å›¾ï¼‰æ€»è§ˆ](https://play.grafana.org/d/000000016/1-time-series-graphs?orgId=1)ã€[â‘¡ æ¯ä¸ªé…ç½®é¡¹çš„ç»†èŠ‚](https://play.grafana.org/d/hxne1Hm4z/1-time-series-features-detailed-overview?orgId=1)
{: .ant-alert .ant-alert-info}

ä»¥ Grafana æœ€æ–°ç‰ˆæ²™ç›’ä¸ºä¾‹ï¼Œé¢æ¿ç¼–è¾‘é¡µçš„å¸¸ç”¨é…ç½®é¡¹ (ä»ä¸Šåˆ°ä¸‹)ï¼š

* Aliasã€Tooltip é™åºæ’åˆ—ã€Legend Show As Tableï¼šç•¥ï¼Œè§ä¸Šæ–‡

* Axisï¼š
  * Placementï¼šåæ ‡è½´æ”¾åœ¨å“ªé‡Œï¼Œé»˜è®¤é å·¦

  * æŒ‰å¯¹æ•°æ¯”ä¾‹å±•ç¤ºï¼š[Demo - å¯¹æ•° Scale](https://play.grafana.org/d/000000040/logarithmic-scales?orgId=1&editPanel=1)

* Graph stylesï¼š
  * Linesã€Barsã€Pointsï¼šæ˜¾ç¤ºä¸ºæŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾è¿˜æ˜¯æ•£ç‚¹å›¾
  * Line widthï¼šçº¿å®½
  * Fill opacityï¼šæŠ˜çº¿å›¾æ˜¯å¦è¦æœ‰å¡«å……ï¼Œå»ºè®®è®¾ç½®ä¸º 0
  * Line styleï¼šçº¿æ¡æ ·å¼ï¼Œå®çº¿ or è™šçº¿ or ç‚¹çŠ¶ï¼Œé€‚ç”¨äºåŒæ¯”è§†å›¾ä¸­ï¼ŒåŒºåˆ†ä»Šå¤©å’Œæ˜¨å¤©çš„æ›²çº¿
  * Show pointsï¼šæ˜¯å¦å±•ç¤ºæ¯ä¸ªæ•°æ®ç‚¹ (é»˜è®¤åªå±•ç¤ºæŠ˜çº¿)

* Standard options - Unitï¼šå»ºè®®é…ç½®åˆç†çš„å•ä½ï¼Œä»¥æå‡çœ‹æ¿çš„å¯è¯»æ€§
  - QPSï¼šMisc - short
  - åˆ©ç”¨ç‡ï¼šMisc - Percent (0.0~1.0)
  - å¸¦å®½ï¼šData - bytes
  - å»¶è¿Ÿï¼šTime - microseconds (us)
  override

* Data linksï¼šæ·»åŠ é“¾æ¥ï¼Œè¯¦è§ [4.3-æå‡é¢æ¿çš„å¯è¯»æ€§](#readability)

* Value mappingsï¼šæŒ‰æ¡ä»¶å°†æŸä¸ªå€¼æ˜ å°„ä¸ºå…¶ä»–å€¼ï¼Œæ¯”å¦‚å°† `P0`ã€`P1`  æ˜ å°„ä¸º`æ ¸å¿ƒ`ã€`éæ ¸å¿ƒ`

* Thresholdsï¼šæ·»åŠ ä¸€æ¡é˜ˆå€¼çº¿ (æˆ–å¡«å……åŒºåŸŸ)ã€‚å¯ä»¥é…ç½®é˜ˆå€¼çš„é¢œè‰²å’Œå€¼ï¼Œé»˜è®¤**å¤§äº**é˜ˆå€¼çš„åŒºåŸŸä¼šè¢«å¡«å……é¢œè‰²ï¼Œå¦‚æœæƒ³è¡¨è¾¾â€œä½äºé˜ˆå€¼â€æ—¶æ˜¯å¼‚å¸¸æƒ…å†µ (æ¯”å¦‚æœåŠ¡ SLO æŒ‡æ ‡)ï¼Œå¯ä»¥æ›¿æ¢ä¸‹å›¾ä¸­ Base å’Œ 80 çš„é¢œè‰²ã€‚

  ![image-20240406004127227](/media/grafana/image-20240406004127227.png)

* Series Overrideï¼šä¸€ä¸ªå¾ˆæœ‰ç”¨çš„åŠŸèƒ½ï¼ŒæŒ‰ç…§æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ›²çº¿åç§°ï¼Œç„¶åä¿®æ”¹è¿™äº›æ›²çº¿çš„å±æ€§ã€‚å¸¸è§çš„ä½¿ç”¨åœºæ™¯æ˜¯ï¼š(1) ä¸ºæŸäº›ç‰¹æ®Šçš„æ›²çº¿æŒ‡å®šé¢œè‰²ï¼Œæ¯”å¦‚æ€»æ˜¯é«˜äº®æ ¸å¿ƒæœåŠ¡ï¼›(2) å°†åç§°ä¸­åŒ…å« `test` çš„æ›²çº¿è®¾ç½®ä¸ºè™šçº¿ï¼Œè¡¨ç¤ºè¿™äº›æ˜¯æµ‹è¯•æ•°æ®ï¼›(3) åœ¨ä¸€ä¸ªé¢æ¿ä¸­ç”»ä¸¤æ¡æ›²çº¿ï¼Œå…¶ä¸­ä¸€æ¡æ›²çº¿çš„çºµè½´åœ¨å·¦ä¾§ï¼Œå¦ä¸€æ¡æ›²çº¿çš„çºµè½´åœ¨å³ä¾§ (ä¿®æ”¹ Y-Axes)ã€‚

### Pie é¥¼å›¾

é¥¼å›¾é€‚åˆè¡¨ç¤ºå„é¡¹æ•°æ®çš„å æ¯”ï¼š

![image-20240406010555305](/media/grafana/image-20240406010555305.png)

ğŸ’¡ Grafana å®˜æ–¹çš„æ¼”ç¤ºçœ‹æ¿ï¼š[é¥¼å›¾å’ŒæŸ±çŠ¶å›¾](https://play.grafana.org/d/ktMs4D6Mk/5-bar-charts-and-pie-charts?orgId=1)ã€[Piechart é¥¼å›¾](https://play.grafana.org/d/-Kj3rZdGz/piechart?orgId=1)
{: .ant-alert .ant-alert-info}

åœ¨æ—§ç‰ˆæœ¬çš„ Grafana ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªâ€œCombine (only for percentages)â€é…ç½®é¡¹ï¼Œå¯ä»¥å°†å æ¯”ä½äºæŒ‡å®šé˜ˆå€¼çš„æ•°æ®éƒ½èšåˆæˆ"Others"ï¼Œè¿™æ ·é¥¼å›¾å°±ä¸ä¼šå‡ºç°å¾ˆå¤šå æ¯”éå¸¸å°çš„åŒºåŸŸäº†ã€‚

### Bar ç›´æ–¹å›¾ / æŸ±çŠ¶å›¾

![image-20240406010043454](/media/grafana/image-20240406010043454.png)

ğŸ’¡ Grafana å®˜æ–¹çš„æ¼”ç¤ºçœ‹æ¿ï¼š[é¥¼å›¾å’ŒæŸ±çŠ¶å›¾](https://play.grafana.org/d/ktMs4D6Mk/5-bar-charts-and-pie-charts?orgId=1)
{: .ant-alert .ant-alert-info}

* Stackingï¼šæ˜¯å¦è¦å°†æ‰€æœ‰ç›´æ–¹å›¾å †å èµ·æ¥ã€‚é€‚åˆå±•ç¤ºä¸€äº›å…³å¿ƒæ¯ä¸ªæ—¶åˆ»æ€»å’Œçš„æŒ‡æ ‡ï¼Œæ¯”å¦‚å½“å‰æœ‰å¤šå°‘å°æœºå™¨ Coredump äº†ã€‚

### Gauge æ°´ä½çº¿

Gauge é€‚åˆå±•ç¤ºæ€»ä½“æ°´ä½ï¼Œæ¯”å¦‚å¸¦å®½æ˜¯å¦æ»¡äº†ï¼Œæˆ–è€…æœåŠ¡ç¨³å®šæ€§æ˜¯å¦è·Œç ´é˜ˆå€¼ã€‚

![image-20230722231032773](/media/grafana/image-20230722231032773.png)

ğŸ’¡ Grafana å®˜æ–¹çš„æ¼”ç¤ºçœ‹æ¿ï¼š[Gauge](https://play.grafana.org/d/KIhkVD6Gk/4-gauges?orgId=1&refresh=10s)ã€[Bar Gauge](https://play.grafana.org/d/vmie2cmWz/bar-gauge?orgId=1&refresh=10s)
{: .ant-alert .ant-alert-info}

### Stat ç»Ÿè®¡

çªå‡ºæ˜¾ç¤ºå½“å‰æ—¶åˆ»çš„å€¼ï¼Œå¯ä»¥åœ¨åº•éƒ¨ä»¥é˜´å½±æ–¹å¼æ˜¾ç¤ºè¿™æ®µæ—¶é—´çš„æ›²çº¿ã€‚

![image-20230722230754838](/media/grafana/image-20230722230754838.png)

ğŸ’¡ Grafana å®˜æ–¹çš„æ¼”ç¤ºçœ‹æ¿ï¼š[Stat ç»Ÿè®¡](https://play.grafana.org/d/Zb3f4veGk/2-stats?orgId=1)
{: .ant-alert .ant-alert-info}

### Text / Markdown / HTML æ–‡æœ¬

Text ç±»å‹çš„é¢æ¿æ”¯æŒå†™ Markdown æˆ–è€… HTMLã€‚

Markdown é€‚åˆå†™çœ‹æ¿çš„ä½¿ç”¨è¯´æ˜ï¼š

![image-20240406011449181](/media/grafana/image-20240406011449181.png)

HTML å¯ä»¥å†™æ›´å¤æ‚çš„å†…å®¹ï¼Œæ¯”å¦‚æŠŠå¦ä¸€ä¸ª Grafana å†…åµŒåˆ°å½“å‰ Grafanaï¼š

```HTML
<iframe 
src="https://{grafanaé“¾æ¥}?kiosk=tv&${__url_time_range}" 
width="100%" height="100%" frameborder="0"></iframe>
```

ä¸Šé¢ `src` é‡Œçš„ `kiosk=tv` æ”¹æˆ `kiosk`ï¼Œè¢«åµŒå…¥çš„çœ‹æ¿å°±æ²¡æœ‰æ ‡é¢˜æ ã€å˜é‡æ ã€Links äº†ï¼Œèåˆåº¦æ›´å¥½ã€‚

## å…­ã€é“¾æ¥ Links
{: #links}

Grafana Dashboard é¡¶éƒ¨å¯ä»¥å±•ç¤ºé“¾æ¥ï¼Œé€šå¸¸ä¼šåœ¨è¿™é‡Œé™„åŠ å…¶ä»–çœ‹æ¿å’Œç›¸å…³æ–‡æ¡£çš„é“¾æ¥ã€‚

![image-20240406132300574](/media/grafana/image-20240406132300574.png)

æ·»åŠ é“¾æ¥ï¼šSettings â†’ Links â†’ New linkï¼Œç‚¹å‡»å³è¾¹çš„ â†‘ â†“ ç®­å¤´å¯ä»¥è°ƒæ•´é¡ºåºã€‚

![image-20240406132130917](/media/grafana/image-20240406132130917.png)

é…ç½®é¡¹ï¼š

![image-20240406132127748](/media/grafana/image-20240406132127748.png)

* é“¾æ¥æ ‡é¢˜
* é“¾æ¥ç±»å‹ï¼šDashboards æˆ– Linkï¼Œå‰è€…æ˜¯ç½—åˆ—å½“å‰ç³»ç»Ÿé‡Œçš„æ‰€æœ‰çœ‹æ¿ï¼Œåè€…æ˜¯è‡ªå®šä¹‰é“¾æ¥ã€‚
* URLï¼šé“¾æ¥åœ°å€ã€‚è¿™é‡Œå¯ä»¥ä¼ é€’çœ‹æ¿é‡Œçš„[å˜é‡](#use-variable)ï¼Œæ¯”å¦‚é…ç½®äº† `xxx.com?${foo:queryparam}`ï¼Œå¦‚æœå½“å‰çœ‹æ¿çš„ `foo` å˜é‡å–å€¼ä¸º `123`ï¼Œåˆ™ä¼šç”Ÿæˆè¿™æ ·çš„é“¾æ¥ï¼š`xxx.com?foo=123`ã€‚
* Tooltipï¼šé¼ æ ‡ç§»ä¸Šå»ä¼šæœ‰ä¸€ä¸ªæç¤ºè¯´æ˜ã€‚
* `include current time range`ï¼šç‚¹å‡»é“¾æ¥è·³è½¬æ—¶ï¼Œåœ¨ url é‡Œä¼ é€’å½“å‰çœ‹æ¿é€‰æ‹©çš„æ—¶é—´èŒƒå›´ `from=xxx&to=xxx`ã€‚å¦‚æœé“¾æ¥æ˜¯å¦ä¸€ä¸ªçœ‹æ¿ï¼Œåˆ™æ¨èå‹¾é€‰ã€‚
* `include current template variable values`ï¼šç‚¹å‡»é“¾æ¥è·³è½¬æ—¶ï¼Œåœ¨ url é‡Œä¼ é€’å½“å‰çœ‹æ¿é€‰æ‹©çš„æ‰€æœ‰å˜é‡ `foo=xxx&bar=xxx&baz=xxx`ã€‚å¦‚æœé“¾æ¥æ˜¯å¦ä¸€ä¸ªçœ‹æ¿ä¸”å˜é‡é…ç½®æ˜¯ä¸€è‡´çš„ï¼Œåˆ™æ¨èå‹¾é€‰ã€‚
* `Open link in new tab`ï¼šåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼Œæ¨èå‹¾é€‰ã€‚

## ä¸ƒã€å…¶ä»– Others

**Dashboard Settingsï¼š**

* **Auto refresh**ï¼šé…ç½®ä¸åŒçš„è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼Œåœ¨å³ä¸Šè§’é€‰æ‹©ï¼Œä¹‹åçœ‹æ¿ä¼šæ¯éš”æœ‰å•æ—¶é—´å°±è‡ªåŠ¨åˆ·æ–°

  ![image-20240406140354809](/media/grafana/image-20240406140354809.png)

  ![image-20240406140443330](/media/grafana/image-20240406140443330.png)

* **Now delay**ï¼šæŸäº›æ•°æ®æºçš„æ•°æ®æœ‰å»¶è¿Ÿï¼Œæœ€æ–°æ—¶åˆ»çš„æ•°æ®å¯èƒ½ä¸å‡†ï¼Œç›‘æ§ä¸Šä¼šå‡ºç°æ‰åº•ã€‚è§£å†³åŠæ³•æ˜¯é…ç½® Now delayï¼Œæ€»æ˜¯ä¸¢å¼ƒæ‰æœ€è¿‘ 30s çš„æ•°æ®ã€‚

  ![image-20240406140723421](/media/grafana/image-20240406140723421.png)

* **æ‰“å¼€ Crosshair**ï¼šDashboard Settings - Graph tooltipï¼Œåœ¨ä¸åŒ Panel ä¸­åŒæ­¥æ˜¾ç¤ºå½“å‰é¼ æ ‡æ‰€æŒ‡çš„æ—¶åˆ»ã€‚

  ![image-20240406140721056](/media/grafana/image-20240406140721056.png)

---

**äº¤äº’ï¼š**

* åœ¨ Grafana Panel é‡Œæ‹–åŠ¨å¯ä»¥é€‰æ‹©ä¸€æ®µæ—¶é—´èŒƒå›´ï¼Œæ”¾å¤§æŸ¥çœ‹æ•°æ®ï¼š

  ![image-20240406140559946](/media/grafana/image-20240406140559946.png)

---

* Grafana Panel ç¼–è¾‘é¡µâ€œQueryâ€å³è¾¹è¿˜æœ‰ä¸€ä¸ªâ€œTransform dataâ€åŠŸèƒ½ã€‚é€šè¿‡ Transform å¯ä»¥å¯¹ Query ç»“æœç›¸åŠ ã€ç›¸é™¤æˆ–åˆå¹¶ç­‰ã€‚å…¸å‹çš„åº”ç”¨åœºæ™¯æ˜¯â€œåˆ†åˆ«é…ç½®æˆåŠŸååå’Œå¤±è´¥ååçš„ä¸¤ä¸ª Queryï¼Œç„¶åé…ç½®ä¸€ä¸ª Transformï¼Œè®¡ç®—é”™è¯¯ç‡â€ï¼Œå¥½å¤„æ˜¯ç›¸æ¯”äº Bosun è¡¨è¾¾å¼å¯è¯»æ€§æ›´é«˜ã€‚

  ![image-20240406141137156](/media/grafana/image-20240406141137156.png)



## é™„å½•

### Grafana å®˜æ–¹ç¤ºä¾‹çœ‹æ¿

Grafana å®˜æ–¹æä¾›çš„æ‰€æœ‰ç¤ºä¾‹ï¼š<https://play.grafana.org/dashboards>ã€‚

é™¤äº†ä¸Šæ–‡å·²ç»åˆ—å‡ºæ¥çš„ç¤ºä¾‹ï¼Œè¿™é‡Œæ”¶å½•äº†ä¸€äº›å…¶ä»–å¯èƒ½æœ‰ç”¨çš„çœ‹æ¿ï¼š

* [Canvas ç”»å¸ƒ](https://play.grafana.org/d/7p7JkqWVz/panel-tests-canvas-examples?orgId=1)
* Table è¡¨æ ¼ï¼š[First Demo](https://play.grafana.org/d/OhR1ID6Mk/3-table?orgId=1)ã€[Second Demo](https://play.grafana.org/d/U_bZIMRMk/table-panel-showcase?orgId=1)ã€[Third Demo](https://play.grafana.org/d/T512JVH7z/loki-nginx-service-mesh-json-version?orgId=1&var-datasource=LGTM%20Stack%20-%20Loki&var-label_name=filename&var-label_value=All&var-job=All&var-instance=All&viewPanel=6)
* [State timeline, Status history](https://play.grafana.org/d/qD-rVv6Mz/6-state-timeline-and-status-history?orgId=1)
* [Flow chart æµç¨‹å›¾](https://play.grafana.org/d/NpjdeVWGz/flowcharting-bug-draw-io-940?orgId=1)ï¼šåµŒå…¥ Draw.io
  * [Second Demo](https://play.grafana.org/d/ubByxW2Gz/flowcharting-dc-floor?orgId=1)ã€[Third Demo](https://play.grafana.org/d/Kcic5xeWz/flowcharting-events-and-animations?orgId=1)
  * [å¯ä»¥å±•å¼€ã€æŠ˜å çš„ Demo](https://play.grafana.org/d/JG78lp0Zk/flowcharting-expand-and-collapse?orgId=1)
  * [é¼ æ ‡æµ®åœ¨å›¾ç‰‡ä¸Šï¼Œèƒ½çœ‹åˆ°å¯¹åº”çš„ Metrics æ•°æ®](https://play.grafana.org/d/yNQz3OCZk/flowcharting-floorplan?orgId=1&refresh=30s)
  * [æ¶æ„å›¾](https://play.grafana.org/d/p5F-FKCZk/flowcharting-technical-architecture?orgId=1)

å®Œæ•´ Demoï¼š

* [Grafana Dashboard](https://play.grafana.org/d/3SWXxreWk/grafana-dashboard?orgId=1)ï¼šæŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€Bar Gaugeã€‚Graphite æ•°æ®é›†ã€‚

  ![image-20230722170943238](/media/grafana/image-20230722170943238.png)

* [Stats Overview](https://play.grafana.org/d/cL5pLH7Wz/stats-overview?orgId=1)ï¼šæŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€Gauge ä»ªè¡¨ç›˜ã€Bar Gaugeã€Statã€‚

* [Big Dashboard](https://play.grafana.org/d/000000045/big-dashboard?orgId=1)ï¼šæŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€å †å ã€ç»Ÿè®¡ã€‚Graphite æ•°æ®é›†ã€‚

* [Loki NGINX Service Mesh](https://play.grafana.org/d/T512JVH7z/)ï¼šæŠ˜çº¿å›¾ã€Statã€Gaugeã€Mapã€Log æ—¥å¿—ã€Table (å†…åµŒ Gauge)ã€‚

* [Business Metrics](https://play.grafana.org/d/000000110/business-metrics?orgId=1)ï¼šStat ç»Ÿè®¡ã€é˜ˆå€¼ã€‚

* [Multiple Panel Test Example](https://play.grafana.org/d/d5dd0b9e-6c85-40dc-ad57-a2f703f3b92a/public-dashboards-multiple-panel-test-example?orgId=1)ï¼šæ‰€æœ‰ç±»å‹çš„çœ‹æ¿é€Ÿè§ˆï¼ŒåŒ…æ‹¬ Textã€Geomapã€State timelineã€Logsã€Histogramã€Heatmapã€Gaugeã€Pie chartã€Tableã€Time Seriesã€Statã€Bar chartã€‚

* [Kubernetes æœåŠ¡èµ„æºåˆ©ç”¨ç‡](https://play.grafana.org/d/a87fb0d919ec0ea5f6543124e16c42a5/kubernetes-compute-resources-namespace-workloads?orgId=1&refresh=30s)

### æœåŠ¡ç›‘æ§é¢æ¿åº”è¯¥å¦‚ä½•å»ºè®¾

ä¸€ä¸ªæœåŠ¡çº§åˆ«çš„çœ‹æ¿ï¼Œåº”å½“åŒ…å«è¿™å‡ è¡Œï¼š

- æœåŠ¡æ•´ä½“ (CPUã€å†…å­˜ã€ååã€å»¶æ—¶ç­‰æ ¸å¿ƒæŒ‡æ ‡)
- ä¸Šæ¸¸è°ƒç”¨ (ä¸Šæ¸¸æˆåŠŸååã€å¤±è´¥ååã€Error Codeã€é”™è¯¯ç‡ã€å»¶æ—¶ Avgã€å»¶æ—¶ P99)
  - > è¿™é‡Œè¦åœ¨å‚æ•°å’Œ tags é‡Œé…ç½® fromï¼ŒåŒºåˆ†ä¸åŒä¸Šæ¸¸ï¼›é…ç½® methodï¼ŒåŒºåˆ†ä¸åŒæ¥å£ã€‚
- è°ƒç”¨ä¸‹æ¸¸ (è°ƒç”¨ä¸‹æ¸¸æˆåŠŸååã€å¤±è´¥ååã€Error Codeã€é”™è¯¯ç‡ã€å»¶æ—¶ Avgã€å»¶æ—¶ P99 ç­‰)
  - > è¿™é‡Œè¦åœ¨å‚æ•°å’Œ tags é‡Œé…ç½® toï¼ŒåŒºåˆ†ä¸åŒä¸‹æ¸¸ã€‚
- å¼‚å¸¸æƒ…å†µ (é”™è¯¯æ—¥å¿—ã€Coredumpã€Panic ç­‰)
- å†…éƒ¨çŠ¶æ€ (è§†æœåŠ¡è€Œå®šï¼Œå¦‚å€™é€‰æ¡æ•°ã€ç¼“å­˜å¤§å°ç­‰)
- åˆ†æ­¥éª¤å»¶æ—¶
- å•æœºè§†å›¾ (CPU åˆ©ç”¨ç‡ã€å†…å­˜åˆ©ç”¨ç‡ã€Error QPS ç­‰ Top 10 çš„ Hostsã€Pods)
- åˆ† Env è§†å›¾ (åˆ†çº¿ä¸Šç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€å°æµé‡ç¯å¢ƒæŸ¥çœ‹ CPU åˆ©ç”¨ç‡ã€å†…å­˜åˆ©ç”¨ç‡ã€Error QPS ç­‰)
- ...

> TODOï¼šé€šç”¨æœåŠ¡å¤§ç›˜ï¼Œç›®å‰ä»…åœ¨å­—èŠ‚å†…ç½‘å¯ç”¨

